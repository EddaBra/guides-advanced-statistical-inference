<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2&nbsp; Multilevel Data Modelling – Guides for Advanced Statistical Inference</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./panel_data.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cd7de1037569933fbb609f06423bd096.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./multi-level.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Multilevel Data Modelling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Guides for Advanced Statistical Inference</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multi-level.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Multilevel Data Modelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./panel_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Panel Data</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-load.libraries" id="toc-sec-load.libraries" class="nav-link active" data-scroll-target="#sec-load.libraries"><span class="header-section-number">2.1</span> Load libraries</a></li>
  <li><a href="#multi-level-issue" id="toc-multi-level-issue" class="nav-link" data-scroll-target="#multi-level-issue"><span class="header-section-number">2.2</span> Multi level issue</a>
  <ul class="collapse">
  <li><a href="#sec-ml.ex" id="toc-sec-ml.ex" class="nav-link" data-scroll-target="#sec-ml.ex"><span class="header-section-number">2.2.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#random-intercept-model-rim-or-random-effects-model" id="toc-random-intercept-model-rim-or-random-effects-model" class="nav-link" data-scroll-target="#random-intercept-model-rim-or-random-effects-model"><span class="header-section-number">2.3</span> Random Intercept Model (RIM) or Random Effects Model</a>
  <ul class="collapse">
  <li><a href="#fixed-or-random-effects-for-groups" id="toc-fixed-or-random-effects-for-groups" class="nav-link" data-scroll-target="#fixed-or-random-effects-for-groups"><span class="header-section-number">2.3.1</span> Fixed or Random Effects for Groups?</a></li>
  <li><a href="#intraclass-correlation-coefficent" id="toc-intraclass-correlation-coefficent" class="nav-link" data-scroll-target="#intraclass-correlation-coefficent"><span class="header-section-number">2.3.2</span> Intraclass Correlation Coefficent</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise"><span class="header-section-number">2.3.3</span> Exercise</a></li>
  <li><a href="#adding-covariates" id="toc-adding-covariates" class="nav-link" data-scroll-target="#adding-covariates"><span class="header-section-number">2.3.4</span> Adding Covariates</a></li>
  <li><a href="#exercise-1" id="toc-exercise-1" class="nav-link" data-scroll-target="#exercise-1"><span class="header-section-number">2.3.5</span> Exercise</a></li>
  <li><a href="#between--within-groups" id="toc-between--within-groups" class="nav-link" data-scroll-target="#between--within-groups"><span class="header-section-number">2.3.6</span> Between- / Within-Groups</a></li>
  <li><a href="#ecological-fallacy" id="toc-ecological-fallacy" class="nav-link" data-scroll-target="#ecological-fallacy"><span class="header-section-number">2.3.7</span> Ecological fallacy</a></li>
  <li><a href="#model-fit-with-r-squares" id="toc-model-fit-with-r-squares" class="nav-link" data-scroll-target="#model-fit-with-r-squares"><span class="header-section-number">2.3.8</span> Model fit with R squares</a></li>
  <li><a href="#exercise-2" id="toc-exercise-2" class="nav-link" data-scroll-target="#exercise-2"><span class="header-section-number">2.3.9</span> Exercise</a></li>
  </ul></li>
  <li><a href="#prediction-on-random-effects" id="toc-prediction-on-random-effects" class="nav-link" data-scroll-target="#prediction-on-random-effects"><span class="header-section-number">2.4</span> Prediction on Random Effects</a>
  <ul class="collapse">
  <li><a href="#exercise-3" id="toc-exercise-3" class="nav-link" data-scroll-target="#exercise-3"><span class="header-section-number">2.4.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#random-slope-model" id="toc-random-slope-model" class="nav-link" data-scroll-target="#random-slope-model"><span class="header-section-number">2.5</span> Random Slope Model</a></li>
  <li><a href="#cross-level-interaction" id="toc-cross-level-interaction" class="nav-link" data-scroll-target="#cross-level-interaction"><span class="header-section-number">2.6</span> Cross-Level Interaction</a>
  <ul class="collapse">
  <li><a href="#sec-cross.ex" id="toc-sec-cross.ex" class="nav-link" data-scroll-target="#sec-cross.ex"><span class="header-section-number">2.6.1</span> Exercise</a></li>
  <li><a href="#exercise-model-comparision" id="toc-exercise-model-comparision" class="nav-link" data-scroll-target="#exercise-model-comparision"><span class="header-section-number">2.6.2</span> Exercise Model comparision</a></li>
  </ul></li>
  <li><a href="#statistical-testing" id="toc-statistical-testing" class="nav-link" data-scroll-target="#statistical-testing"><span class="header-section-number">2.7</span> Statistical Testing</a>
  <ul class="collapse">
  <li><a href="#exercise-4" id="toc-exercise-4" class="nav-link" data-scroll-target="#exercise-4"><span class="header-section-number">2.7.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#testing-random-effects-with-the-lieklihood-ratio-test-lrt" id="toc-testing-random-effects-with-the-lieklihood-ratio-test-lrt" class="nav-link" data-scroll-target="#testing-random-effects-with-the-lieklihood-ratio-test-lrt"><span class="header-section-number">2.8</span> Testing random effects with the lieklihood-ratio test (LRT)</a></li>
  <li><a href="#random-slope-variances" id="toc-random-slope-variances" class="nav-link" data-scroll-target="#random-slope-variances"><span class="header-section-number">2.9</span> Random Slope Variances</a></li>
  <li><a href="#explained-variance" id="toc-explained-variance" class="nav-link" data-scroll-target="#explained-variance"><span class="header-section-number">2.10</span> Explained Variance</a>
  <ul class="collapse">
  <li><a href="#exercise-6" id="toc-exercise-6" class="nav-link" data-scroll-target="#exercise-6"><span class="header-section-number">2.10.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#heteroscedasticity" id="toc-heteroscedasticity" class="nav-link" data-scroll-target="#heteroscedasticity"><span class="header-section-number">2.11</span> Heteroscedasticity</a></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics"><span class="header-section-number">2.12</span> Diagnostics</a>
  <ul class="collapse">
  <li><a href="#are-there-contextual-effects-not-considered-test-effects-and-group-means" id="toc-are-there-contextual-effects-not-considered-test-effects-and-group-means" class="nav-link" data-scroll-target="#are-there-contextual-effects-not-considered-test-effects-and-group-means"><span class="header-section-number">2.12.1</span> Are there contextual effects not considered? Test effects and group means</a></li>
  <li><a href="#level-1-residual-analysis" id="toc-level-1-residual-analysis" class="nav-link" data-scroll-target="#level-1-residual-analysis"><span class="header-section-number">2.12.2</span> Level-1 residual analysis</a></li>
  <li><a href="#level-2-residual-analysis" id="toc-level-2-residual-analysis" class="nav-link" data-scroll-target="#level-2-residual-analysis"><span class="header-section-number">2.12.3</span> Level-2 residual analysis</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Multilevel Data Modelling</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><em>Recommended literature:</em></p>
<p>Snijders, T. A., &amp; Bosker, R. J. (2011). Multilevel analysis: An introduction to basic and advanced multilevel modeling. Sage.</p>
<section id="sec-load.libraries" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-load.libraries"><span class="header-section-number">2.1</span> Load libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mitml)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjlabelled)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer) <span class="do">##comparing models</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjmisc)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom.mixed)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sjPlot) </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="multi-level-issue" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="multi-level-issue"><span class="header-section-number">2.2</span> Multi level issue</h2>
<ul>
<li>Micro units are nested within macro units</li>
<li>Micro units impact on macro units and vice versa
<ul>
<li>Micro units within a macro unit tend to be more similar to each other as compared to other micro units in other macro units</li>
<li>Observations are not any longer independent of each other</li>
<li>In statistical analysis this impacts on their variances</li>
<li>Neglecting this issue leads likely at least to wrong variance estimates, in the worst case to biased estimates</li>
</ul></li>
</ul>
<p>→ Multilevel analysis is a suitable approach to take into account the social contexts as well as the individual respondents or subjects.</p>
<section id="sampling" class="level4" data-number="2.2.0.1">
<h4 data-number="2.2.0.1" class="anchored" data-anchor-id="sampling"><span class="header-section-number">2.2.0.1</span> Sampling</h4>
<ul>
<li>Cluster sampling, multi-stage sampling are standard</li>
<li>Secondary units are not selected independently of each other
<ul>
<li>having selected the primary units increases the chance of sampling the secondary units → Ignoring may heavily impact on the variance estimates and may thus produce type I error (reject a true null hypothesis)</li>
</ul></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.Cluster.png" class="img-fluid figure-img" width="200"></p>
<figcaption>Sampling units</figcaption>
</figure>
</div>
<p>Two arguments for multilevel instead of single level regression of disaggregated data:</p>
<ol type="1">
<li>Dependence as a nuisance:</li>
</ol>
<ul>
<li>Standard errors and tests base on single-level regression are suspect because the assumption of independent residuals is invalid.</li>
</ul>
<ol start="2" type="1">
<li>Dependence as an interesting phenomenon:</li>
</ol>
<ul>
<li>It is interesting in itself to disentangle variability at the various levels; moreover, this can give insight in the directions where further explanation may fruitfully be sought.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.level_terms.png" class="img-fluid figure-img" width="200"></p>
<figcaption>multi level terms</figcaption>
</figure>
</div>
</section>
<section id="modelling" class="level4" data-number="2.2.0.2">
<h4 data-number="2.2.0.2" class="anchored" data-anchor-id="modelling"><span class="header-section-number">2.2.0.2</span> Modelling</h4>
<p><strong>Hierarchical linear model</strong> is a type of regression analysis for multilevel data where the dependent variable is at the lowest level.</p>
<ul>
<li>Explanatory variables can be defined at any level (including aggregates of level-one variables).</li>
<li>Also longitudinal data can be regarded as a nested structure; for such data the hierarchical linear model is convenient as well (with some particularities).</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.model.png" class="img-fluid figure-img" width="200"></p>
<figcaption>Modelling</figcaption>
</figure>
</div>
</section>
<section id="sec-ml.ex" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="sec-ml.ex"><span class="header-section-number">2.2.1</span> Exercise</h3>
<ol type="1">
<li>Load library <code>library(lme4)</code></li>
</ol>
<p>Already done, see <a href="#sec-load.libraries" class="quarto-xref"><span>Section 2.1</span></a>.</p>
<ol start="2" type="1">
<li>Load the data:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>DAT <span class="ot">&lt;-</span> <span class="fu">read.csv2</span>(<span class="st">"data/1.Example.txt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Have a look at the data</li>
</ol>
<p>How many observations and variables?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(DAT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   3454 obs. of  11 variables:
 $ schoolnr   : int  174 44 83 64 172 201 259 218 109 88 ...
 $ pupilNR_new: int  2923 681 1332 1041 2879 3405 4207 3682 1719 1435 ...
 $ langPOST   : int  37 43 41 52 35 49 22 42 30 52 ...
 $ ses        : num  -14.73 -2.73 -7.73 3.27 -2.73 ...
 $ IQ_verb    : num  -2.87 -0.37 0.13 1.13 -2.37 2.63 0.63 -0.37 -4.87 1.63 ...
 $ sex        : int  0 1 0 0 1 0 0 1 1 1 ...
 $ Minority   : int  0 0 0 0 0 0 0 1 1 0 ...
 $ denomina   : int  5 3 5 1 2 3 1 3 1 2 ...
 $ sch_ses    : num  -7.68 -8.98 5.75 3.23 -3.7 ...
 $ sch_iqv    : num  0.252 -0.742 0.503 0.252 -0.226 ...
 $ sch_min    : num  0 0.188 0 0.091 0 0.115 0.111 0.92 0.19 0 ...</code></pre>
</div>
</div>
<p>In the data set for each pupil is measured:</p>
<ul>
<li>which school he/she belongs to (schoolnr)</li>
<li>what her/ his unique pupil number is (pupuilNR_new)</li>
<li>what score the pupil reach in his/hers language test (our dependent variable) (langPOST)</li>
<li>what its socio-economic background is (ses) - a binary variable that indicates the sex, if the pupil belongs to a minority (Minority) - the verbal IQ of the pupil, centered by the mean (IQ_verbal)</li>
</ul>
<p>And the dataset contains measures for each school</p>
<ul>
<li>the schools socio-economic backgrounds (school_ses)</li>
<li>the verbal IQ of all pupils in a school (school_iqv)</li>
<li>an index how many pupils in a school belongs to a minority (school_min)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(DAT<span class="sc">$</span>pupilNR_new))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3454</code></pre>
</div>
</div>
<p>3454 observations = pupils 11 variables over all. Each pupil has a pupil number, that is unique and is assigned to one of 211 schools.</p>
<p>For overview let’s get some inside in the descriptives of each variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(DAT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    schoolnr      pupilNR_new      langPOST          ses           
 Min.   :  1.0   Min.   :   3   Min.   : 8.00   Min.   :-17.73000  
 1st Qu.: 69.0   1st Qu.:1130   1st Qu.:36.00   1st Qu.: -7.73000  
 Median :135.0   Median :2200   Median :42.00   Median : -1.73000  
 Mean   :132.1   Mean   :2171   Mean   :41.32   Mean   :  0.04678  
 3rd Qu.:189.0   3rd Qu.:3209   3rd Qu.:48.00   3rd Qu.:  8.27000  
 Max.   :259.0   Max.   :4214   Max.   :58.00   Max.   : 22.27000  
    IQ_verb              sex            Minority          denomina    
 Min.   :-7.87000   Min.   :0.0000   Min.   :0.00000   Min.   :1.000  
 1st Qu.:-0.87000   1st Qu.:0.0000   1st Qu.:0.00000   1st Qu.:1.000  
 Median : 0.13000   Median :0.0000   Median :0.00000   Median :2.000  
 Mean   : 0.03098   Mean   :0.4896   Mean   :0.04806   Mean   :2.257  
 3rd Qu.: 1.13000   3rd Qu.:1.0000   3rd Qu.:0.00000   3rd Qu.:3.000  
 Max.   : 6.63000   Max.   :1.0000   Max.   :1.00000   Max.   :5.000  
    sch_ses             sch_iqv           sch_min       
 Min.   :-17.72700   Min.   :-4.8113   Min.   :0.00000  
 1st Qu.: -4.38100   1st Qu.:-0.3668   1st Qu.:0.00000  
 Median :  0.13000   Median : 0.0932   Median :0.00000  
 Mean   :  0.03116   Mean   : 0.0127   Mean   :0.05202  
 3rd Qu.:  4.43900   3rd Qu.: 0.4665   3rd Qu.:0.05900  
 Max.   : 15.54500   Max.   : 2.4769   Max.   :0.92000  </code></pre>
</div>
</div>
<p>The schoolnr for the 211 schools ranges from 1 to 259.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">is.na.data.frame</span>(DAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
FALSE 
37994 </code></pre>
</div>
</div>
<p>No missing values in the data frame.</p>
<p>Get insight in the distribution of each variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(DAT<span class="sc">$</span>ses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(DAT<span class="sc">$</span>sch_ses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(DAT<span class="sc">$</span>IQ_verb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-6-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(DAT<span class="sc">$</span>sch_iqv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-6-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(DAT<span class="sc">$</span>Minority)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-6-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(DAT<span class="sc">$</span>sch_min)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-6-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>ses is left scewed,more pupils have a lower ses than the mean,- this is not true for schools</li>
<li>iqverb is slightly right scewed, range is wider on the negative site than on the possitve, this is also true for distribution of schools</li>
<li>distribution for the mean IQ has more outliers on the negative side than on the positive side</li>
<li>only under 10 percent of the pupils belongs to a minority, there are a lot schools where none of the pupils belongs to a minority group, while there are some schools, where all pupils belongs to a minority.</li>
</ul>
</section>
</section>
<section id="random-intercept-model-rim-or-random-effects-model" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="random-intercept-model-rim-or-random-effects-model"><span class="header-section-number">2.3</span> Random Intercept Model (RIM) or Random Effects Model</h2>
<ul>
<li><span class="math inline">\(i\)</span> indicates the individual level-one unit</li>
<li><span class="math inline">\(j\)</span> indicates the group, level two unit</li>
<li>variables for individual <span class="math inline">\(i\)</span> in group <span class="math inline">\(j\)</span>:
<ul>
<li><span class="math inline">\(Y_{ij}\)</span></li>
<li><span class="math inline">\(x_{ij}\)</span> explanatory variable at level one</li>
</ul></li>
<li>for group <span class="math inline">\(j\)</span>
<ul>
<li><span class="math inline">\(z_j\)</span> explanatory at level two</li>
<li><span class="math inline">\(n_j\)</span> group size<br>
<strong>OLS regression model</strong> of <span class="math inline">\(Y\)</span> on <span class="math inline">\(x\)</span> ignoring groups</li>
</ul></li>
</ul>
<p><span class="math display">\[
Y_{ij} = \beta_0 + \beta_1x_{ij}+ R_{ij}
\]</span></p>
<p><span class="math inline">\(R_{ij}\)</span> is not the error term, it is the residual term: An error term is generally unobservable and a residual is observable and calculable, making it much easier to quantify and visualize. In effect, while an error term represents the way observed data differs from the actual population, a residual represents the way observed data differs from sample population data.</p>
<p><strong>group dependent regression model</strong> is dependent on groups, the following notation means, that the units on level 2 (indivudals) have random intercepts</p>
<p><span class="math display">\[
Y_ij = \beta_{0j} + \beta_{1j}x_{ij}+ R_{ij}
\]</span></p>
<p>In the random intercept model, the intercepts <span class="math inline">\(\beta_{0j}\)</span> are random variables representing random differences between groups, where <span class="math inline">\(\beta_{0j} =\)</span> average intercept <span class="math inline">\(\gamma00\)</span> (for all level two units) plus group-dependent deviation <span class="math inline">\(U_{0j}\)</span></p>
<p><span class="math display">\[
\beta_{0j} = \gamma_{00} + U_{0j}
\]</span></p>
<p>In this model, the regression coefficient <span class="math inline">\(β_1\)</span> is common to all the groups (otherwise random slope model)</p>
<p>In a fixed effects model each group has own intercept <span class="math inline">\(\beta_{0j}\)</span> to be estimated, because <span class="math inline">\(\beta_{0j} =\)</span> is not a random variable.</p>
<p>In the random intercept model, the constant regression coefficient <span class="math inline">\(β_1\)</span> is sometimes denoted <span class="math inline">\(\gamma_{10}\)</span> →</p>
<p><span class="math display">\[
Y_{ij} = \gamma_{00} + \gamma_{10}x_{ij}+U_{0j}+ R{ij}
\]</span><br>
</p>
<p>In the hierarchical linear model, the <span class="math inline">\(U_{0j}\)</span> are random variables. The model assumption is that they are independent, normally distributed with expected value <span class="math inline">\(0\)</span>, and variance from</p>
<p><span class="math display">\[
\tau^2 = var(U_{0j})
\]</span></p>
<p>The statistical parameter in the model is not their individual values, but their variance <span class="math inline">\(tau^2\)</span>. <span class="math inline">\(U_{0j}\)</span> represent the random intercept for each cluster. It’s really a residual term that measures the distance from each subject’s intercept around the overall intercept <span class="math inline">\(β_0\)</span>. Rather than calculate an estimate for every one of those distances, the model is able to just estimate a single variance. This is the <strong>between group variance</strong>.</p>
<p>The <strong>within-group variance</strong> is measured by the variance of residuals. Their sum is the total variance in <span class="math inline">\(Y\)</span> that is not explained by <span class="math inline">\(X\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.random-regression.png" class="img-fluid figure-img" width="400"></p>
<figcaption>Random regression lines</figcaption>
</figure>
</div>
<section id="fixed-or-random-effects-for-groups" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="fixed-or-random-effects-for-groups"><span class="header-section-number">2.3.1</span> Fixed or Random Effects for Groups?</h3>
<p>Arguments for choosing between fixed (F) and random (R) coefficient models for the group dummies:</p>
<ol type="1">
<li>If groups are unique entities and inference should focus on these groups: F. This often is the case with a small number of groups. $rarr; good for countries</li>
<li>If groups are regarded as sample from a (perhaps hypothetical) population and inference should focus on this population: R This often is the case with a large number of groups.</li>
<li>If group sizes are small and there are many groups, and it is reasonable to assume exchangeability of group-level residuals, then R makes better use of the data.</li>
<li>If the researcher is interested only in within-group effects, and is suspicious about the model for between-group differences, then F is more robust.</li>
</ol>
<ul>
<li>In groups we need enough variance and distribution</li>
</ul>
<ol start="5" type="1">
<li>If group effects <span class="math inline">\(U_{0j}\)</span> (etc.) are not nearly normally distributed, R is risky (or use more complicated multilevel models).</li>
</ol>
<p>A fixed effect and a random effect are two different statistical models used in data analysis, including in the context of meta-analysis and regression analysis. Here is a brief explanation of each:</p>
<section id="fixed-effect" class="level4" data-number="2.3.1.1">
<h4 data-number="2.3.1.1" class="anchored" data-anchor-id="fixed-effect"><span class="header-section-number">2.3.1.1</span> Fixed Effect:</h4>
<p>In a fixed effect model, the assumption is that the effects being studied are constant across all levels of the categorical variable(s) being considered. It assumes that the observed differences are due to the characteristics of the entities being studied, rather than being random or varying across different groups. In a fixed effect model, the parameters being estimated are specific to the entities or groups being analyzed. The fixed effect model is appropriate when the goal is to estimate the specific effects of each entity or group and to make inferences about those specific entities or groups. helen says</p>
</section>
<section id="random-effect" class="level4" data-number="2.3.1.2">
<h4 data-number="2.3.1.2" class="anchored" data-anchor-id="random-effect"><span class="header-section-number">2.3.1.2</span> Random Effect:</h4>
<p>In a random effect model, the assumption is that the effects being studied are not constant across all levels of the categorical variable(s) being considered. It assumes that the observed differences are due to a combination of the characteristics of the entities being studied and random variation. In a random effect model, the parameters being estimated represent the average effects across all entities or groups being analyzed, as well as the variability between entities or groups. The random effect model is appropriate when the goal is to estimate the average effects across all entities or groups and to make inferences about the population of entities or groups. It is important to choose the appropriate model based on the research question and the characteristics of the data. The choice between fixed effect and random effect models depends on the underlying assumptions and the goals of the analysis.</p>
<p>Here are some additional resources that may be helpful: pubmed.ncbi.nlm.nih.gov A basic introduction to fixed-effect and random-effects models … - PubMed PMID: 26061376 DOI: 10.1002/jrsm.12 Abstract There are two popular statistical models for meta-analysis, the fixed-effect model and the random-effects model…</p>
</section>
</section>
<section id="intraclass-correlation-coefficent" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="intraclass-correlation-coefficent"><span class="header-section-number">2.3.2</span> Intraclass Correlation Coefficent</h3>
<p>To deduce if multi-level is necessary &amp; appropriate use the intraclass correlation coefficient.</p>
<p>If their is no correlation among the observations within a cluster, cluster means won’t differ (no between-group variance)</p>
<p>Start with the empty model (random effects ANOVA) is a model without explanatory variables:</p>
<p><span class="math display">\[
Y_{ij} = \gamma_{00} + U_{0j} + R_{ij}
\]</span></p>
<p>Variance decomposition:</p>
<p><span class="math display">\[
var (Y_{ij}) = var (U_{0j}) + var (R_{ij}) =\tau^2 + \sigma^2
\]</span></p>
<p>Can the covariates on individual level be explained by the group j? Check for <strong>intraclass correlation coefficient (ICC)</strong>. The ratio of the between-cluster variance to the total variance is called the Intraclass Correlation. If the correlation is zero, then nothing of the variance comes in addition.</p>
<ul>
<li>Covariance between two individuals (i ̸= k) in the same group j :</li>
</ul>
<p><span class="math display">\[
    cov(Y_{ij} ,Y_{kj}) = var(U_{0j}) = \tau^2
\]</span></p>
<p>And their correlation with the intraclass correlation coefficient (ICC).</p>
<p><span class="math display">\[
ρ(Y_{ij} ,Y_{kj}) = ρ(Y) =\frac{\tau^2}{\tau^2 + \sigma^2}
\]</span></p>
<p>It is the proportion what is left unexplained in only looking at the single level. The higher the covariance is, the more multi level analysis is appropriate and can give explanation. The higher the difference between the classes, the higher is the intraclass correlation coefficient. → what are the threshold values indicating an RIM oder random coefficent model?</p>
<ul>
<li>Often between 0.05 and 0.25 in social science research, where the groups represent some kind of social grouping.</li>
</ul>
</section>
<section id="exercise" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="exercise"><span class="header-section-number">2.3.3</span> Exercise</h3>
<ul>
<li>micro units: 3454 pupils</li>
<li>macro units: 211 schools</li>
<li>Y is a language test <em>langPost</em></li>
</ul>
<ol type="1">
<li>Estimate empty model:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(langPOST <span class="co">#dependent variable</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>             <span class="sc">~</span>  (<span class="dv">1</span><span class="sc">|</span>schoolnr), <span class="co">#independent variable &amp; random effect is in this case the school number</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> DAT, <span class="co">#data</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">REML =</span> <span class="cn">TRUE</span>) <span class="co"># a robust estimator </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod1) <span class="co">#get summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ (1 | schoolnr)
   Data: DAT

REML criterion at convergence: 24482.5

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.0887 -0.6236  0.0769  0.7279  2.5470 

Random effects:
 Groups   Name        Variance Std.Dev.
 schoolnr (Intercept) 18.78    4.333   
 Residual             63.20    7.950   
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
            Estimate Std. Error       df t value Pr(&gt;|t|)    
(Intercept)  40.9224     0.3325 192.7084   123.1   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod1) <span class="co"># only fixed effects</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
    40.9224 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(mod1) <span class="co"># for confindence intervals</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Computing profile confidence intervals ...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                2.5 %    97.5 %
.sig01       3.821700  4.889329
.sigma       7.759807  8.147763
(Intercept) 40.266476 41.574208</code></pre>
</div>
</div>
<p><code>.sig01</code> stands for <span class="math inline">\(\tau^2\)</span> → does not be centered around zero, like expected. <code>.sigma</code> stands for <span class="math inline">\(\sigma^2\)</span></p>
<p>REML stands for <a href="https://en.wikipedia.org/wiki/Restricted_maximum_likelihood">restricted maximum likelihood method</a>. LMER uses this because numerically fitting a mixed-effects model can be difficult and the maximum likelihood approach often fails.</p>
<p>The empty model shows, how the language test results differ between the schools. It is the estimated true group mean. Overall we have an estimate of 40.9224. The residual variance on the school level is 18.78 (variance), the one on the individual level is 63.20.</p>
<ol start="2" type="1">
<li>Derive the ICC from the output. Assess whether it is really necessary to use a multi-level model for analyzing this data set.</li>
</ol>
<ul>
<li><span class="math inline">\(\tau^2\)</span>, is the variance of <span class="math inline">\(U_{0j} = 18.78\)</span></li>
<li><span class="math inline">\(\sigma^2\)</span> is the variance of the residual <span class="math inline">\(R_{ij} = 63.2\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fl">18.78</span> <span class="sc">/</span> (<span class="fl">18.78</span> <span class="sc">+</span> <span class="fl">63.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2290803</code></pre>
</div>
</div>
<p>Because ICC is between 0.05 and 0.25 an RIM is appropriate. It indicates, that there is a variance, that can be explained by schools → a between-group variance.</p>
<ol start="3" type="1">
<li>What is the estimated mean of the total population of individual values <span class="math inline">\(Y_{ij}\)</span> and the corresponding standard deviation?</li>
</ol>
<p>The estimated mean of the total population is 40.9224 (see the summmary of mod1, fixed effects and the intercept) with a standard error 0.3325.</p>
<p>The standard deviation is for this total population is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Multiply the mean SE (derived from the fixed effects, SE for the intercept) with the square root of the sample size.</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.3325</span> <span class="sc">*</span> (<span class="fu">sqrt</span>(<span class="dv">3454</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 19.54127</code></pre>
</div>
</div>
<ol start="4" type="1">
<li>What is the estimated mean of the population of class means <span class="math inline">\(\beta_{0j}\)</span> and the corresponding standard deviation?</li>
</ol>
<p>In this model no difference expected, because is the same, variance should be explained on the individual level</p>
</section>
<section id="adding-covariates" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="adding-covariates"><span class="header-section-number">2.3.4</span> Adding Covariates</h3>
<p>The model becomes more interesting, when also fixed effects of explanatory variables are included:</p>
<p><span class="math display">\[
Y_{ij}  = γ_{00} + γ_10x_{ij} + U_{0j} + R_{ij}
\]</span></p>
<p>Note the difference between fixed effects of explanatory variables and fixed effects of group dummies.</p>
<p>There are two kinds of parameters: 1. fixed effects: regression coefficients γ (just like in OLS regression) 2. random effects: <span class="math inline">\(U_{0j}\)</span> determined by variance component <span class="math inline">\(\tau_0^2\)</span></p>
</section>
<section id="exercise-1" class="level3" data-number="2.3.5">
<h3 data-number="2.3.5" class="anchored" data-anchor-id="exercise-1"><span class="header-section-number">2.3.5</span> Exercise</h3>
<ol type="1">
<li>Add the covariate for IQ into the model on micro-level, <strong>linear model</strong> without multi-level</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST <span class="sc">~</span> IQ_verb, <span class="at">data=</span>DAT) <span class="co">#independent micro variable</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = langPOST ~ IQ_verb, data = DAT)

Residuals:
     Min       1Q   Median       3Q      Max 
-29.2571  -4.5436   0.6551   5.0996  25.9592 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 41.23512    0.12120  340.21   &lt;2e-16 ***
IQ_verb      2.64326    0.05928   44.59   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 7.122 on 3452 degrees of freedom
Multiple R-squared:  0.3654,    Adjusted R-squared:  0.3652 
F-statistic:  1988 on 1 and 3452 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Estimate also a <strong>multi-level model (RIM)</strong>, and compare both. Discuss!</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mod3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span> IQ_verb <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + (1 | schoolnr)
   Data: DAT

REML criterion at convergence: 22972.9

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.1563 -0.6283  0.0789  0.7130  3.1760 

Random effects:
 Groups   Name        Variance Std.Dev.
 schoolnr (Intercept) 10.22    3.197   
 Residual             41.14    6.414   
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept) 4.099e+01  2.497e-01 1.980e+02  164.13   &lt;2e-16 ***
IQ_verb     2.497e+00  5.725e-02 3.432e+03   43.61   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
        (Intr)
IQ_verb 0.004 </code></pre>
</div>
</div>
<p>We can see, the model gives more explanation, if we used the linear mixed-effects model 3. The variance in model 3 for between group and within group is much more smaller than in model 1. The scaled residuals in model 3 are in an less expanded range, than the residuals in model 2, that indicates a better model fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.122464</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.413664</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>?sigma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Help on topic 'sigma' was found in the following packages:

  Package               Library
  glmmTMB               /home/runner/work/_temp/renv/cache/v5/R-4.3/x86_64-pc-linux-gnu/glmmTMB/1.1.10/09c1a82cf7f80e2289aaf8267345dfd1
  lme4                  /home/runner/work/_temp/renv/cache/v5/R-4.3/x86_64-pc-linux-gnu/lme4/1.1-35.5/16a08fc75007da0d08e0c0388c7c33e6
  stats                 /opt/R/4.3.1/lib/R/library


Using the first match ...</code></pre>
</div>
</div>
<p>In addition the overall variance is decreasing, too.</p>
<section id="more-covariates" class="level4" data-number="2.3.5.1">
<h4 data-number="2.3.5.1" class="anchored" data-anchor-id="more-covariates"><span class="header-section-number">2.3.5.1</span> More Covariates</h4>
<p>The model becomes more interesting, when also fixed effects of explanatory variables are included:</p>
<p><span class="math display">\[
Y_{ij} = γ_{00} \\
+ γ_{10}x_{1ij} + . . . + γ_{p0}x_{pij} \\
+ γ_{01z1j} + . . . + γ_{0qzqj}\\
+ U_{0j} + R_{ij}\\
\]</span></p>
<ul>
<li><span class="math inline">\(γ_00\)</span> is zero</li>
<li><span class="math inline">\(+ γ_10x1ij + . . . + γp0xpij\)</span> within-group (micro units) differences, for individual variable 1 you have a covariate for the unit belonging to a group. For variable <span class="math inline">\(p\)</span> you have also a covariate for the unit belonging to a group</li>
<li><span class="math inline">\(+ γ_01z1j + . . . + γ_0qzqj\)</span> all the between groups (macro units) coefficients,for group variable 1 you have a covariate for the unit belonging to a group. For variable p you have also a covariate for the unit belonging to a group</li>
</ul>
</section>
</section>
<section id="between--within-groups" class="level3" data-number="2.3.6">
<h3 data-number="2.3.6" class="anchored" data-anchor-id="between--within-groups"><span class="header-section-number">2.3.6</span> Between- / Within-Groups</h3>
<p><strong>What difference you are interested in?</strong></p>
<p>Difference between within-group and between-group regressions:</p>
<ul>
<li>The within-group regression coefficient (<span class="math inline">\(+ γ_10x1ij + . . . + γp_0xpij\)</span>) is the regression coefficient within each group, assumed to be the same across the groups. → <span class="math inline">\(\sigma^2\)</span></li>
<li>The between-group regression coefficient (<span class="math inline">\(+ γ_01z1j + . . . + γ_0qzqj\)</span>) is defined as the regression coefficient for the regression of the group means of <span class="math inline">\(Y\)</span> on the group means of <span class="math inline">\(X\)</span>.→ <span class="math inline">\(\tau^2\)</span></li>
<li>This distinction is essential to avoid ecological fallacies → if you ignore, what happen on the lowest level, you will make ecological fallacies</li>
</ul>
</section>
<section id="ecological-fallacy" class="level3" data-number="2.3.7">
<h3 data-number="2.3.7" class="anchored" data-anchor-id="ecological-fallacy"><span class="header-section-number">2.3.7</span> Ecological fallacy</h3>
<p>(also ecological inference fallacy or population fallacy) is a formal fallacy in the interpretation of statistical data that occurs when inferences about the nature of individuals are deduced from inferences about the group to which those individuals belong.</p>
<ul>
<li>Example: Inference and generalization mistake: All the French eat snails, what is obviously not true</li>
</ul>
<p>4 types:</p>
<ol type="1">
<li>confusion between ecological (population) correlations and individual correlations</li>
<li>confusion between group average and total average</li>
<li><a href="https://de.wikipedia.org/wiki/Simpson-Paradoxon">Simpson’s paradox</a>: as Simpson-Paradoxon (auch simpsonsches Paradoxon oder Simpson’sches Paradoxon, benannt nach Edward Hugh Simpson) ist ein Paradoxon aus der Statistik. Dabei scheint es, dass die Bewertung verschiedener Gruppen unterschiedlich ausfällt, je nachdem ob man die Ergebnisse der Gruppen kombiniert oder nicht. Dieses Phänomen tritt auf, wenn Störvariablen in der statistischen Analyse nicht betrachtet werden. Durch die Nichtbeachtung der Gruppen kommt es zu einer Scheinkorrelation.</li>
<li>confusion between higher average and higher likelihood</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.simpson-paradox.png" class="img-fluid figure-img" width="300"></p>
<figcaption>Simpson Paradox</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.regression-lines.png" class="img-fluid figure-img" width="300"></p>
<figcaption>Regression lines</figcaption>
</figure>
</div>
<p>In the model with separate effects for the original variable <span class="math inline">\(x_{ij}\)</span> and the group mean</p>
<p><span class="math display">\[
Yij = \tilde{y}_{00} + \tilde{y}_{10}\hat{x}_{ij} + \tilde{y}_{01}\hat{x.}_j + U_{0j} + R_{ij}
\]</span></p>
<ul>
<li>the within-group regression coefficient is <span class="math inline">\(γ_{10}\)</span></li>
<li>between-group regression coefficient is <span class="math inline">\(γ_{10} + γ_{01}\)</span></li>
</ul>
<p>Test difference between within-group and between-group coefficients: consider <span class="math inline">\(\tilde{γ}_{10}= y_{10}, \tilde{γ}_{01} = y_{10} + y_{01}\)</span></p>
<p>Both models are equivalent, and have the same fit:</p>
<p><span class="math display">\[
\tilde{γ}_{10} = γ_{10}, \tilde{γ}_{01} = γ_{10} + γ_{01}
\]</span></p>
</section>
<section id="model-fit-with-r-squares" class="level3" data-number="2.3.8">
<h3 data-number="2.3.8" class="anchored" data-anchor-id="model-fit-with-r-squares"><span class="header-section-number">2.3.8</span> Model fit with R squares</h3>
<p><span class="math inline">\(R^2\)</span> = 1- (unexplained variance / total variance)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">multilevelR2</span>(mod3, <span class="at">print =</span> <span class="fu">c</span>(<span class="st">"RB1"</span>, <span class="st">"RB2"</span>, <span class="st">"SB"</span>, <span class="st">"MVP"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      RB1       RB2        SB       MVP 
0.3491123 0.4556720 0.3735188 0.3365584 </code></pre>
</div>
</div>
<ul>
<li>RB1 and RB2 returns the explained variance at level 1 and level 2, respectively, according to Raudenbush and Bryk (2002, pp.&nbsp;74 and 79)</li>
<li>Specifying SB returns the total variance explained according to Snijders and Bosker (2012, p.&nbsp;112).</li>
<li>Specifying MVP returns the total variance explained based on “multilevel variance partitioning” as proposed by LaHuis, Hartman, Hakoyama, and Clark (2014).</li>
</ul>
<p>But note: Don’t infer from <span class="math inline">\(R^2\)</span> if multi level should be used or not! Use the ICC for that</p>
</section>
<section id="exercise-2" class="level3" data-number="2.3.9">
<h3 data-number="2.3.9" class="anchored" data-anchor-id="exercise-2"><span class="header-section-number">2.3.9</span> Exercise</h3>
<ol type="1">
<li>Add a group level effect for IQ using the R commands</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>groupM <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(DAT<span class="sc">$</span>IQ_verb, <span class="at">by=</span><span class="fu">list</span>(DAT<span class="sc">$</span>schoolnr), <span class="at">FUN=</span>mean)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(groupM) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"schoolnr"</span>, <span class="st">"IQ_mean"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>DAT <span class="ot">&lt;-</span> <span class="fu">merge</span>(DAT, groupM, <span class="at">by=</span><span class="st">"schoolnr"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this command we add a group mean for the verbal IQ per school. With this group mean we separate the effects from each other, So we have the intercept for the school &amp; the verbal IQ mean in school for explaining the between group variance and for the within group variance the verbal IQ</p>
<ol start="2" type="1">
<li>Compare the RIM model with and without this group level variable, with a special focus on the level-2 variance. Explain!</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>mod4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span> IQ_verb <span class="sc">+</span> IQ_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + (1 | schoolnr)
   Data: DAT

REML criterion at convergence: 22972.9

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.1563 -0.6283  0.0789  0.7130  3.1760 

Random effects:
 Groups   Name        Variance Std.Dev.
 schoolnr (Intercept) 10.22    3.197   
 Residual             41.14    6.414   
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept) 4.099e+01  2.497e-01 1.980e+02  164.13   &lt;2e-16 ***
IQ_verb     2.497e+00  5.725e-02 3.432e+03   43.61   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
        (Intr)
IQ_verb 0.004 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + IQ_mean + (1 | schoolnr)
   Data: DAT

REML criterion at convergence: 22951.2

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.1741 -0.6263  0.0696  0.7037  3.1791 

Random effects:
 Groups   Name        Variance Std.Dev.
 schoolnr (Intercept)  9.119   3.020   
 Residual             41.096   6.411   
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept) 4.102e+01  2.389e-01 2.012e+02 171.677  &lt; 2e-16 ***
IQ_verb     2.438e+00  5.857e-02 3.240e+03  41.634  &lt; 2e-16 ***
IQ_mean     1.275e+00  2.641e-01 2.616e+02   4.827 2.36e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
        (Intr) IQ_vrb
IQ_verb  0.000       
IQ_mean  0.018 -0.222</code></pre>
</div>
</div>
<p>Model 1 (empty model with classes fixed), Model 2 (+ individual intelligence score), Model 3 (+group mean of intelligence score). → more explanation, group mean is significant!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.413664</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.410607</code></pre>
</div>
</div>
<p>The variance in the random effects between model 3 and 4 is decreasing and more is explained. In mod4 the variance of the residuals and the residual standard deviation is decreasing. Also standard errors are slightly decreasing.</p>
</section>
</section>
<section id="prediction-on-random-effects" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="prediction-on-random-effects"><span class="header-section-number">2.4</span> Prediction on Random Effects</h2>
<p><em>only possible after model computation, because only then we have the estimates, we can predict from!</em></p>
<p>The random effects <span class="math inline">\(U_{0j}\)</span> are not statistical parameters and therefore they are not estimated as part of the estimation routine. However, sometimes it might be necessary to predict them.</p>
<p>Note: It is often not a good idea, because their are predicted, not statistical facts!</p>
<p>There are two ways to get them:</p>
<ol type="1">
<li><p>The ML estimator of <span class="math inline">\(U_{0j}\)</span> is the group means of the residuals <span class="math inline">\(Yij − (\tilde{γ}_{00} + x′{ij} \hat{γ})\)</span> → we have estimated the parameters out of the available data. The ML estimator of <span class="math inline">\(U_{0j}\)</span>of the group means of the residuals is possible, because <span class="math inline">\(\tilde{γ}_{00}\)</span> is equal to zero. (See the <a href="#sec-ml.ex" class="quarto-xref"><span>Section 2.2.1</span></a>)</p></li>
<li><p>By the empirical Bayes method; the resulting predictions are the posterior means. The posterior mean for group j is based on two kinds of information:</p></li>
</ol>
<ul>
<li>sample information: the data in group j population information:</li>
<li>the value U0j was drawn from a normal distribution with mean 0 and variance τ 2</li>
</ul>
<p>Suppose we wish to predict the ‘true group mean’ <span class="math inline">\(γ_00 + U_{0j}\)</span> For simplicity consider empty model (without coefficient): <span class="math inline">\(Y{ij} = β_0j + R{ij} = γ_00 + U0j + R{ij}\)</span> → Estimating <span class="math inline">\(β_0j\)</span> and <span class="math inline">\(U0j\)</span> are equivalent problems given that <span class="math inline">\(\hatγ_00\)</span> is available</p>
<p>The empirical Bayes estimate (combined estimate) is a weighted average of the group mean and the overall mean:</p>
<p><span class="math display">\[
\hat{\beta}^{EB}_{0j} = λj \overline{Y}_{.j} + (1 − λj )\hat{γ_00}
\]</span></p>
<p>where the weight <span class="math inline">\(λ_j\)</span> is the ‘reliability’ of the mean of group <span class="math inline">\(j\)</span> (with <span class="math inline">\(n_j\)</span> is related group size)</p>
<p><span class="math display">\[
λj =\frac{τ^2_0}{τ 2 0 + σ^2/n_j}
=
\frac{n_jρ_I}{1 + (n_j − 1)ρ_I}
\]</span></p>
<p>The reliability coefficient indicates how well the true mean <span class="math inline">\(γ_00 + U_{0j}\)</span> is measured by the observed mean <span class="math inline">\(\overline{Y}_{.j}\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.Bayes.png" class="img-fluid figure-img" width="300"></p>
<figcaption>Empirical Bayes estimators</figcaption>
</figure>
</div>
<p>Empirical Bayes ‘estimates’ (EB) are biased, but the bias gets smaller with increasing group sizes.</p>
<p>We see that the EB are “shrunk towards the mean”. (EB are also called shrinkage estimators.)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.Bayes-error.png" class="img-fluid figure-img" width="300"></p>
<figcaption>Error Bayes</figcaption>
</figure>
</div>
<p>→ checking for standard errors is very important! Therefore, compute the comparative and diagnostic standard errors.</p>
<p><strong>Comparative</strong> (use: comparison of random effects of different level 2 units): * deviation from unobserved random variable <span class="math inline">\(U_{0j}\)</span></p>
<p><span class="math display">\[
S.E_{comp}(\hat{U}^{EB}_{0j}) = S.E. (\hat{U}^{EB}_{0j} - U_{0j})
\]</span></p>
<p>how well can the unobserved level-2 contribution of <span class="math inline">\(U_{0j}\)</span> can be ‘estimated’ from the data</p>
<p><strong>Diagnostic</strong> (use: model checking (checking normality of the level-1 residuals))</p>
<ul>
<li>Express the deviation from 0, which is the overall mean of the variables <span class="math inline">\(U_{0j}\)</span></li>
</ul>
<p><span class="math display">\[
S.E_{comp}(\hat{U}^{EB}_{0j}) = S.E. (\hat{U}^{EB}_{0j})
\]</span></p>
<ul>
<li>an be seen as standardized residuals having a std. normal distribution if model is correct</li>
</ul>
<section id="exercise-3" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="exercise-3"><span class="header-section-number">2.4.1</span> Exercise</h3>
<p>Estimates of random effects with <code>ranef</code>. This function gibes the conditional modes of the random effects of a fitted model object. → it is the difference between the population-level average predicted response for a given set of fixed-effects values and the response predicted for a particular individual.</p>
<ul>
<li>You can think of these as individual-level effects, i.e.&nbsp;how much does any individual differ from the population?</li>
<li>They are also, roughly, equivalent to the modes of the Bayesian posterior densities for the deviations of the individual group effects from the population means</li>
</ul>
<p>→ important to keep in mind: not parameters, so no standard errors are defined.</p>
<ol type="1">
<li>Predict the school-level random effects (EB, for all N = 211 schools), using the R command <code>ranef(model)</code> (‘model’ is name of estimated model in R)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>be_u <span class="ot">&lt;-</span> <span class="fu">ranef</span>(mod4)<span class="sc">$</span>schoolnr[[<span class="dv">1</span>]] <span class="co"># schoolnr[[1]] is the bayes estimate for the level-1 unit for each school, computed in model 4</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(be_u), <span class="fu">sort</span>(be_u), <span class="at">pch=</span><span class="dv">20</span>, <span class="at">xlab=</span><span class="st">"schoolNr"</span>, <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">'U'</span>[<span class="st">'0j'</span>])) <span class="co">#plot all the bayes estimates for the schools sorted from the largest to the highest</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>mlm <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">sort</span>(be_u) <span class="sc">~</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(be_u))) <span class="do">## plot a line: estimate linear model first</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a=</span><span class="fu">coef</span>(<span class="fu">summary</span>(mlm))[<span class="dv">1</span>,<span class="dv">1</span>], <span class="at">b=</span><span class="fu">coef</span>(<span class="fu">summary</span>(mlm))[<span class="dv">2</span>,<span class="dv">1</span>]) <span class="do">## then use intercept and slope of that model to plot the line</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>On the vertical axis is the <span class="math inline">\(U_{0j}\)</span> displayed, group-dependent deviation from the average for each school on the x-axis. If a linear regression fit the estimates perfectly, we had perfect normal distribution, because the group dependent variance is around zero.Looking at schools around the median (nearly 50% of the ranked schools), they are centered around <span class="math inline">\(U_{0j}\)</span> → good sign of a random effect.</p>
<ol start="2" type="1">
<li>Plot the confidence intervals to show the differences within the school:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_model</span>(mod4, <span class="at">type =</span> <span class="st">"re"</span>, <span class="at">col=</span><span class="st">"blue"</span>, </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">title=</span><span class="st">"Random Effects on School Level"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows the Bayes estimates for each of the 211 schools in the data set and their confidence intervals. We can see, there are varying means for each school and varying confidence intervals. This indicates variance on the school level and supports multi-level analysis.</p>
<p>Important: Not a robustness check, more a diagnosis, if the method is appropriate! In the attachment, not in the paper!</p>
</section>
</section>
<section id="random-slope-model" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="random-slope-model"><span class="header-section-number">2.5</span> Random Slope Model</h2>
<p>It is possible that not only the group average of Y, but also the effect of X on Y is randomly dependent on the group. That is, in</p>
<p><span class="math display">\[
Y_{ij} = β_{0j} + β_{1j}x_{ij} + R_{ij}
\]</span></p>
<p>it is</p>
<p><span class="math display">\[
β_{0j} = γ_{00} + U_{0j}
β_{1j} = γ_{10} + U_{1j}
\]</span></p>
<p>Example: The effect of gender has a different effects on the grade in different classes.</p>
<p>This gives (X has a random slope):</p>
<p><span class="math display">\[
Y_{ij} = γ_{00} + γ_{10}x_{ij} + U_{0j} + U_{1j}x{ij} + R{ij}
\]</span></p>
<ul>
<li><span class="math inline">\(y_00\)</span> intercept for overall population <span class="math inline">\(γ_{10}x_{ij}\)</span> fixed effects part = fixed effect on gender!</li>
<li><span class="math inline">\(U_{0j}\)</span> random effect of group dependent deviation in the class from the intercept</li>
<li><span class="math inline">\(U_{1j}x{ij}\)</span> effect from random effect of class on the fixed effect gender!</li>
</ul>
<p>Because we would get too much estimators, we need</p>
<p><strong>assumptions</strong>:</p>
<ul>
<li>group-dependent coefficients (<span class="math inline">\(U_{0j}\)</span> ,<span class="math inline">\(U_{1j}\)</span>) are independent across <span class="math inline">\(j\)</span> with a bivariate normal distribution with expected values (0, 0) and covariance matrix defined byVariance of level-1 units (schools)</li>
</ul>
<p><span class="math display">\[
var(U_{0j}) = τ_{00} = τ^2_0
\]</span> Variance of the effect of level-1 units (random effect) on the individual x effect (IQ)</p>
<p><span class="math display">\[
(U_{1j}) = τ_{11} = τ_{21}
\]</span></p>
<p>Co-Variance of school number and IQ</p>
<p><span class="math display">\[
cov(U_{0j},U_{1j}) = τ_{01}
\]</span></p>
<p>This yields: A linear model for the mean structure, and a parameterized covariance matrix within groups with independence between groups.</p>
<section id="sec-slope.ex" class="level4" data-number="2.5.0.1">
<h4 data-number="2.5.0.1" class="anchored" data-anchor-id="sec-slope.ex"><span class="header-section-number">2.5.0.1</span> Exercise</h4>
<ol type="1">
<li>Add a random slope for IQ to your last model. For this: Have a look in the help function of lme4 package who this works.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mod5 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_mean <span class="sc">+</span> IQ_verb <span class="sc">+</span>  (IQ_verb<span class="sc">|</span>schoolnr),  <span class="co">#instead of an intercept (1), we insert IQ_verb as a random slope</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT) </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_mean + IQ_verb + (IQ_verb | schoolnr)
   Data: DAT

REML criterion at convergence: 22932.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2115 -0.6253  0.0740  0.7047  2.7517 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  9.3268  3.0540        
          IQ_verb      0.1896  0.4354   -0.62
 Residual             40.3709  6.3538        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept)  41.03652    0.24111 202.40695 170.201  &lt; 2e-16 ***
IQ_mean       1.03026    0.26543 260.55139   3.882 0.000132 ***
IQ_verb       2.46418    0.06687 179.41415  36.852  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
        (Intr) IQ_men
IQ_mean -0.025       
IQ_verb -0.253 -0.197</code></pre>
</div>
</div>
<p>Model 4 and model 5 have really similar estimates with very similar standard errors and p-values, BUT:</p>
<ul>
<li>Random effect variance of groups is in model 4 slightly smaller (9.119, Std. Error 3.02) than in model 5 (9.3268, Std. Error 3.054)</li>
<li>Standard error in model 4 for IQ_verb(0.058) is smaller than in model 5 (0.06) and so the standard error for the intercept is</li>
<li>Model 5 does not decrease the variance is not an improvement in model fit. Though, it is more complex.</li>
</ul>
<ol start="2" type="1">
<li>Write the regression equation for the estimated model.</li>
</ol>
<p><span class="math display">\[
Y_{ij} = γ_{00} + γ_{10}x_{ij} + U_{0j} + U_{1j}x{ij} + R{ij}\\
langPost_{ij}= γ_{00} + γ_{10}*IQverb_{ij} + y_{01}*IQmean_{j} + U_{0j} + U_{1j}*IQmean_{ij} + R_{ij}\\
Y_{ij} = 41.03 + 2.4864 *IQverb_{ij} +1.030*IQmean_{j} +U_{0j} + U_{1j}*IQverb_{ij} + R_{ij}
\]</span></p>
<p>3.What is the average of the slope for IQ, and what is the related standard deviation?</p>
<p>In model 5 the average of the slope for IQ is 2.46, it is the estimate for IQ_verb. The standard deviation is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Multiply the SE (derived from the fixed effects, SE for the intercept) with the square root of the sample size.</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.06687</span> <span class="sc">*</span> (<span class="fu">sqrt</span>(<span class="dv">3454</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.929999</code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Plot the regression lines for all N=211 schools. What do you find concerning the variance of Y (language test score) related to X (IQ)? (One option for plotting: use the ‘predict’ function for each school separately and plot the predicted Y s along X.)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>schNr <span class="ot">&lt;-</span> <span class="fu">unique</span>(DAT<span class="sc">$</span>schoolnr)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">0</span>, <span class="at">xlim=</span> <span class="fu">range</span>(DAT<span class="sc">$</span>IQ_verb), <span class="at">ylim=</span><span class="fu">range</span>(DAT<span class="sc">$</span>langPOST), <span class="at">col=</span><span class="st">"white"</span>, <span class="at">xlab=</span><span class="st">"IQ"</span>, <span class="at">ylab=</span><span class="st">"langScore"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(schNr)) {</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  pr <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod5, <span class="at">newdata=</span>DAT[DAT<span class="sc">$</span>schoolnr <span class="sc">%in%</span> schNr[i],], <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  iq <span class="ot">&lt;-</span> DAT[DAT<span class="sc">$</span>schoolnr <span class="sc">%in%</span> schNr[i],<span class="st">"IQ_verb"</span>]</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cbind</span>(iq,pr)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(res[,<span class="dv">1</span>], res[,<span class="dv">2</span>])</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In the plot you can see a regression line for the connection between the verbal IQ and the score in the language test. While for lower verbal IQs there is more variance in the language test score, it is less variance for pupils with higher IQ. This could be an indicator, that pupils with an higher IQ have a higher probability to get higher language test scores, while the scores for pupils with lower IQs are more dependent on whhich school you are.</p>
<p>This is a sign for heteroscedacity.</p>
</section>
</section>
<section id="cross-level-interaction" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="cross-level-interaction"><span class="header-section-number">2.6</span> Cross-Level Interaction</h2>
<p>What can we find beyond the random slope?</p>
<p>We add level-2 covariates:</p>
<p>Intercept in the specific group. Is described by the grand mean <span class="math inline">\(γ_{00}\)</span>, the random term <span class="math inline">\(U_{0j}\)</span> and by something on the other level <span class="math inline">\(γ_{01}z_{j}\)</span></p>
<p><span class="math display">\[
β_{0j} = γ_{00} + γ_{01}z_{j} + U_{0j}
\]</span> Coefficient on the slope, the coefficient on the other level and the random term on the other level.</p>
<p>Is described by the grand mean<span class="math inline">\(γ_{10}\)</span>, the random term <span class="math inline">\(U_{1j}\)</span> and by something on the other level <span class="math inline">\(γ_{11}z_{j}\)</span>.</p>
<p><span class="math display">\[
β_{1j} = γ_{10} + γ_{11}z_{j} + U_{1j}
\]</span></p>
<p>Substitution yields</p>
<p><span class="math inline">\(Y{ij} = (y_{00} + y_{01}1z_j + U_{0j})\)</span> (intercept part) <span class="math inline">\(+ (y_10 + y_11z_j + U_{1j})x_{ij}\)</span> (slope part) + <span class="math inline">\(R_{ij} (residual part)\)</span></p>
<p><span class="math inline">\(= y_00\)</span> (grand mean) <span class="math inline">\(+ y_{01}1z_j\)</span> (fixed effect of the teachers gender on the score)+ <span class="math inline">\(y_{10}x_{ij}\)</span> (fixed effect of the gender slope part) + <span class="math inline">\(y_{11}z_{j}x_{ij}\)</span> (cross-level-interaction effect) fixed effect of the teachers gender + the gender on the student of the score) + <span class="math inline">\(U_{0j}\)</span> (random part) + <span class="math inline">\(U_{1j}x_{ij}\)</span>(random slope part of the gender) + <span class="math inline">\(R_{ij}\)</span> residiual part)</p>
<p>Note: * Random effects are still in the model, it don’t have to be included, but can! * Two level equation is brought to one long equatation.</p>
<section id="sec-cross.ex" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1" class="anchored" data-anchor-id="sec-cross.ex"><span class="header-section-number">2.6.1</span> Exercise</h3>
<ol type="1">
<li>Add a cross-level interaction effect for IQ and IQ to your last model. (Hint: Mind that this is still an interaction effect, commonly quantified by the product of two variables.)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>mod6 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_mean <span class="co">#group level effect</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> IQ_verb  <span class="co">#individual effect and main predictor</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> IQ_mean<span class="sc">*</span>IQ_verb <span class="co">#interaction effect</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> (IQ_verb<span class="sc">|</span>schoolnr), <span class="co">#group effect on the individual effect</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_mean + IQ_verb + IQ_mean * IQ_verb + (IQ_verb |  
    schoolnr)
   Data: DAT

REML criterion at convergence: 22929.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2142 -0.6201  0.0777  0.6992  2.8250 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  9.0486  3.0081        
          IQ_verb      0.1666  0.4081   -0.68
 Residual             40.4457  6.3597        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                 Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept)      41.15728    0.24303 212.95671 169.349  &lt; 2e-16 ***
IQ_mean           1.11457    0.26469 258.40361   4.211 3.52e-05 ***
IQ_verb           2.45059    0.06598 176.63512  37.143  &lt; 2e-16 ***
IQ_mean:IQ_verb  -0.16753    0.06580 173.67334  -2.546   0.0118 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_men IQ_vrb
IQ_mean      0.003              
IQ_verb     -0.270 -0.207       
IQ_mn:IQ_vr -0.198 -0.154  0.065</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>What does this effect tell you in the considered case?</li>
</ol>
<p>Including the cross-level interaction effect decreases the variance in the random effects in comparison to model 4 and 5. Especially the variance in IQ_verb is very small now. Its a slightly better model than model 4.</p>
<p>What does the model say us? The higher the IQ mean in a class, the IQ counts less for the score and vice versa.</p>
</section>
<section id="exercise-model-comparision" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2" class="anchored" data-anchor-id="exercise-model-comparision"><span class="header-section-number">2.6.2</span> Exercise Model comparision</h3>
<ol type="1">
<li>Global intercept model / empty model</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data=</span>DAT)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = langPOST ~ 1, data = DAT)

Residuals:
    Min      1Q  Median      3Q     Max 
-33.317  -5.317   0.683   6.683  16.683 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  41.3170     0.1521   271.6   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 8.94 on 3453 degrees of freedom</code></pre>
</div>
</div>
<p>The intercept in the global intercept model is 41.32. This is the mean score for the sample.</p>
<p>See:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>DAT <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">avg=</span><span class="fu">mean</span>(langPOST), <span class="at">sd=</span><span class="fu">sd</span>(langPOST), <span class="at">se=</span> sd<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">3454</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       avg     sd        se
1 41.31702 8.9398 0.1521131</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Two Explanatory variables, IQ and ses on level 1</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST <span class="sc">~</span> IQ_verb <span class="sc">+</span> ses, <span class="at">data =</span>DAT)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = langPOST ~ IQ_verb + ses, data = DAT)

Residuals:
     Min       1Q   Median       3Q      Max 
-30.0374  -4.3797   0.5262   4.8774  25.2335 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 41.23621    0.11799  349.50   &lt;2e-16 ***
IQ_verb      2.36855    0.06102   38.81   &lt;2e-16 ***
ses          0.15868    0.01146   13.85   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6.933 on 3451 degrees of freedom
Multiple R-squared:  0.3988,    Adjusted R-squared:  0.3985 
F-statistic:  1145 on 2 and 3451 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Both explanatory variables and the intercept are significant. Intercept is near to the overall intercept.</p>
<ul>
<li><p>indicates correlation between verbal IQ and language test score: With each verbal IQ point more, the score in the language test will increasee by 2.36.</p></li>
<li><p>indicates correlation between socio economic background and language test score: Whith each point on the ses scale more, the score will increase by 0.15</p></li>
</ul>
<ol start="3" type="1">
<li>two explanatory variables IQ and SES on level-2 (with <span class="math inline">\(\overline{.}\)</span> denotes the group mean)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">#add group mean for ses to the data set</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>groupM <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(DAT<span class="sc">$</span>ses, <span class="at">by=</span><span class="fu">list</span>(DAT<span class="sc">$</span>schoolnr), <span class="at">FUN=</span>mean)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(groupM) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"schoolnr"</span>, <span class="st">"SES_mean"</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>DAT <span class="ot">&lt;-</span> <span class="fu">merge</span>(DAT, groupM, <span class="at">by=</span><span class="st">"schoolnr"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST<span class="sc">~</span>  IQ_mean <span class="sc">+</span> SES_mean, <span class="at">data=</span>DAT)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = langPOST ~ IQ_mean + SES_mean, data = DAT)

Residuals:
    Min      1Q  Median      3Q     Max 
-34.323  -5.325   0.737   6.478  22.030 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  41.2096     0.1428 288.535  &lt; 2e-16 ***
IQ_mean       3.3465     0.1970  16.986  &lt; 2e-16 ***
SES_mean      0.0799     0.0270   2.959  0.00311 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 8.387 on 3451 degrees of freedom
Multiple R-squared:  0.1203,    Adjusted R-squared:  0.1198 
F-statistic: 235.9 on 2 and 3451 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>On level 2 we have significant effects, too. The verbal IQ of a school and the ses mean of school have also significant effects on the language test score.</p>
<p>→ this indicates, that the higher the verbal IQ or the ses mean on a school is, the higher are the language test scores and vice versa.</p>
<ol start="4" type="1">
<li>An interaction effect for IQ and SES on level-1</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST <span class="sc">~</span> IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> IQ_verb<span class="sc">*</span>ses, <span class="at">data =</span> DAT)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stargazer</span>(m2,m4, <span class="at">type=</span><span class="st">"text"</span>, <span class="at">out =</span> <span class="st">"ml.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=========================================================================
                                     Dependent variable:                 
                    -----------------------------------------------------
                                          langPOST                       
                                (1)                        (2)           
-------------------------------------------------------------------------
IQ_verb                      2.369***                   2.338***         
                              (0.061)                    (0.061)         
                                                                         
ses                          0.159***                   0.163***         
                              (0.011)                    (0.011)         
                                                                         
IQ_verb:ses                                             -0.022***        
                                                         (0.005)         
                                                                         
Constant                     41.236***                  41.398***        
                              (0.118)                    (0.124)         
                                                                         
-------------------------------------------------------------------------
Observations                   3,454                      3,454          
R2                             0.399                      0.402          
Adjusted R2                    0.398                      0.402          
Residual Std. Error      6.933 (df = 3451)          6.916 (df = 3450)    
F Statistic         1,144.808*** (df = 2; 3451) 773.270*** (df = 3; 3450)
=========================================================================
Note:                                         *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</code></pre>
</div>
</div>
<p>Overall, with a look on <span class="math inline">\(R^2\)</span> and the Adjusted <span class="math inline">\(R^2\)</span> model 4 has a slightly better model fit to explain the variance on level one. All explanatory variables are still significant.</p>
<p>Its very interesting: The positive effect of IQ_verb is slightly decreasing, while the positive effect of ses is slightly increasing, when the interaction term is included. This means, that an increase in ses will decrease the significance and the effect of IQ or vice versa.</p>
<p>→ It could be a hint, that with with a high level socio economic background a low IQ has less effect or with a low level ses a high verbal IQ has less effect on the test score.</p>
<ol start="5" type="1">
<li>An interaction effect for IQ and SES on level-2</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST<span class="sc">~</span>  IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span> IQ_mean<span class="sc">*</span>SES_mean, <span class="at">data=</span>DAT)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stargazer</span>(m3,m5, <span class="at">type=</span><span class="st">"text"</span>, <span class="at">out =</span> <span class="st">"ml.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=======================================================================
                                    Dependent variable:                
                    ---------------------------------------------------
                                         langPOST                      
                               (1)                       (2)           
-----------------------------------------------------------------------
IQ_mean                     3.347***                  3.171***         
                             (0.197)                   (0.200)         
                                                                       
SES_mean                    0.080***                  0.075***         
                             (0.027)                   (0.027)         
                                                                       
IQ_mean:SES_mean                                      -0.114***        
                                                       (0.023)         
                                                                       
Constant                    41.210***                 41.516***        
                             (0.143)                   (0.155)         
                                                                       
-----------------------------------------------------------------------
Observations                  3,454                     3,454          
R2                            0.120                     0.126          
Adjusted R2                   0.120                     0.126          
Residual Std. Error     8.387 (df = 3451)         8.359 (df = 3450)    
F Statistic         235.878*** (df = 2; 3451) 166.418*** (df = 3; 3450)
=======================================================================
Note:                                       *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</code></pre>
</div>
</div>
<p>Both models has a small and <span class="math inline">\(R^2\)</span> in consequence on its own few explanatory power. Though, the model with the interaction term has higher <span class="math inline">\(R^2\)</span>, what is an indicator for better model fit.</p>
<p>Adding the interaction term decreases the effect of the mean IQ and the mean SES in a school. Like on level 1 there is a negative and significant effect of the interaction term.</p>
<p>→ This one is a bit tough to interpret: If the IQ in one school is on average higher than in another, a higher ses on average has a lower effect on the language test school than in the other school. If the ses in a school on average is very high, the mean IQ on this school will have a lower effect than on a school with lower ses on average.</p>
<ol start="6" type="1">
<li>a cross-level interaction effect for <span class="math inline">\(IQ\)</span> and <span class="math inline">\(\overline{IQ}\)</span></li>
</ol>
<p>See <a href="#sec-cross.ex" class="quarto-xref"><span>Section 2.6.1</span></a> Cross-level interaction:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>m6 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_mean <span class="co">#group level effect</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> IQ_verb  <span class="co">#individual effectof IQ</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> IQ_mean<span class="sc">*</span>IQ_verb <span class="co">#interaction effect</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> (IQ_verb<span class="sc">|</span>schoolnr), <span class="co">#group effect on the individual effect</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_mean + IQ_verb + IQ_mean * IQ_verb + (IQ_verb |  
    schoolnr)
   Data: DAT

REML criterion at convergence: 22929.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2142 -0.6201  0.0777  0.6992  2.8250 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  9.0486  3.0081        
          IQ_verb      0.1666  0.4081   -0.68
 Residual             40.4457  6.3597        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                 Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept)      41.15728    0.24303 212.95671 169.349  &lt; 2e-16 ***
IQ_mean           1.11457    0.26469 258.40361   4.211 3.52e-05 ***
IQ_verb           2.45059    0.06598 176.63512  37.143  &lt; 2e-16 ***
IQ_mean:IQ_verb  -0.16753    0.06580 173.67334  -2.546   0.0118 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_men IQ_vrb
IQ_mean      0.003              
IQ_verb     -0.270 -0.207       
IQ_mn:IQ_vr -0.198 -0.154  0.065</code></pre>
</div>
</div>
<p>We can see that the mean IQ in schools and IQ of an individual have both positive effects on the language score test.</p>
<p>The following hypotheses can be deduced from the results:</p>
<ul>
<li>The higher the verbal IQ, the higher the probability of a better language score results</li>
<li>The higher the IQ is in a school on average, the higher is the probability for pupils to get better language score results. This could be explained by the mechanism, that in school the IQ is high on average, the individual IQ for a majority of pupils is also very high.</li>
<li>The cross interaction effect is negative: If the IQ is in its mean higher in one school, there is lower effect for the individual IQ or vice versa.</li>
<li>That makes sense, because grades and test results are often relational. If there are pupils with very high IQ in one class, a high IQ is not that outstanding and to get good scores is more difficult.</li>
</ul>
<ol start="7" type="1">
<li>A cross-level interaction effect for <span class="math inline">\(ses\)</span> and <span class="math inline">\(\overline{SES}\)</span></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>m7 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  SES_mean <span class="co">#group level effect</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> ses  <span class="co">#individual effect of ses</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> SES_mean<span class="sc">*</span>ses <span class="co">#interaction effect</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> (ses<span class="sc">|</span>schoolnr), <span class="co">#group effect on the individual effect</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
Model failed to converge with max|grad| = 0.00205268 (tol = 0.002, component 1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ SES_mean + ses + SES_mean * ses + (ses | schoolnr)
   Data: DAT

REML criterion at convergence: 24016.5

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.0743 -0.6023  0.0655  0.7254  3.0281 

Random effects:
 Groups   Name        Variance  Std.Dev. Corr 
 schoolnr (Intercept) 13.989984 3.740         
          ses          0.003248 0.057    -0.95
 Residual             55.270465 7.434         
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
               Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)   41.254904   0.306093 229.665686 134.779   &lt;2e-16 ***
SES_mean       0.036492   0.048370 245.391134   0.754   0.4513    
ses            0.310211   0.014904 175.009073  20.813   &lt;2e-16 ***
SES_mean:ses  -0.005794   0.002390 211.679345  -2.424   0.0162 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) SES_mn ses   
SES_mean     0.033              
ses         -0.168 -0.302       
SES_mean:ss -0.305 -0.161 -0.162
optimizer (nloptwrap) convergence code: 0 (OK)
Model failed to converge with max|grad| = 0.00205268 (tol = 0.002, component 1)</code></pre>
</div>
</div>
<p>We can see that the mean SES in schools and the ses of an individual have both positive effects on the language score test, but only the individual ses is significant and moderate high. The cross interaction effect is negative and very small.</p>
<ul>
<li>The higher the ses of a pupil, the higher the probability to get good test scores.</li>
<li>If the school has on average a high the ses, the effect of the individual on test scores decreases. This makes sense, because like intelligence the socio-economic background is perceived relational in a school.</li>
</ul>
<ol start="8" type="1">
<li>a cross-level interaction effect for <span class="math inline">\(IQ\)</span> and <span class="math inline">\(\overline{SES}\)</span></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>m8 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  SES_mean <span class="co">#group level effect</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> IQ_verb  <span class="co">#individual effect of IQ</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> SES_mean<span class="sc">*</span>IQ_verb <span class="co">#interaction effect of the SES in a school on the individual IQ</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> (IQ_verb<span class="sc">|</span>schoolnr), <span class="co">#group effect  on the individual effect</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
Model failed to converge with max|grad| = 0.00241126 (tol = 0.002, component 1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ SES_mean + IQ_verb + SES_mean * IQ_verb + (IQ_verb |  
    schoolnr)
   Data: DAT

REML criterion at convergence: 22941.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2273 -0.6109  0.0784  0.7108  2.7610 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  9.3370  3.0557        
          IQ_verb      0.1787  0.4228   -0.71
 Residual             40.4293  6.3584        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                   Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)       41.136846   0.242649 205.668782 169.533  &lt; 2e-16 ***
SES_mean           0.150259   0.038448 215.849463   3.908 0.000125 ***
IQ_verb            2.478319   0.065495 172.593979  37.840  &lt; 2e-16 ***
SES_mean:IQ_verb  -0.021017   0.009911 153.790000  -2.120 0.035571 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) SES_mn IQ_vrb
SES_mean     0.048              
IQ_verb     -0.299 -0.119       
SES_mn:IQ_v -0.115 -0.260  0.065
optimizer (nloptwrap) convergence code: 0 (OK)
Model failed to converge with max|grad| = 0.00241126 (tol = 0.002, component 1)</code></pre>
</div>
</div>
<p>Not controlled for individual ses, we have a positive effect of the ses on school level and a positive effect of the individual IQ, without controlled for school level IQ. Both effects and the cross level interaction effect is significant. The cross level interaction effect is negative.</p>
<ul>
<li>The higher the ses of pupils on one school is on average, the higher the probability to get high test results (not controlled for individual values of ses)</li>
<li>The higher the the IQ, the higher the probability to get high test results (not controlled for group level values of IQ)</li>
<li>If on a school the average ses is high, the effect of individual IQ on the probablity to get high test results are decreasing and vice versa</li>
</ul>
<ol start="9" type="1">
<li>A cross-level interaction effect for <span class="math inline">\(ses\)</span> and <span class="math inline">\(\overline{IQ}\)</span></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>m9 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_mean <span class="co">#group level effect</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> ses  <span class="co">#individual effect of ses</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> ses<span class="sc">*</span>IQ_mean <span class="co">#interaction effect of the IQ n a school on the individual ses</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>             <span class="sc">+</span> (ses<span class="sc">|</span>schoolnr), <span class="co">#group effect  on the individual effect</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>boundary (singular) fit: see help('isSingular')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m9)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_mean + ses + ses * IQ_mean + (ses | schoolnr)
   Data: DAT

REML criterion at convergence: 23935.8

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2166 -0.6165  0.0820  0.7182  3.0790 

Random effects:
 Groups   Name        Variance  Std.Dev. Corr 
 schoolnr (Intercept) 8.870e+00 2.97819       
          ses         5.278e-04 0.02297  -1.00
 Residual             5.529e+01 7.43601       
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
              Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)   41.21654    0.25065  211.67686 164.440  &lt; 2e-16 ***
IQ_mean        2.51955    0.27462  260.13025   9.175  &lt; 2e-16 ***
ses            0.28517    0.01357 2848.76635  21.022  &lt; 2e-16 ***
IQ_mean:ses   -0.04940    0.01623 2610.71459  -3.045  0.00235 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_men ses   
IQ_mean     -0.018              
ses         -0.076 -0.196       
IQ_mean:ses -0.200  0.075 -0.107
optimizer (nloptwrap) convergence code: 0 (OK)
boundary (singular) fit: see help('isSingular')</code></pre>
</div>
</div>
<p>There are positive, significant effect of the mean IQ in a school and the individual ses on the language test score and a negative, significant cross level interaction effect.</p>
<ul>
<li>The higher the IQ of pupils on one school is on average, the higher the probability to get high test results (not controlled for individual values of IQ)</li>
<li>The higher the the individual ses, the higher the probability to get high test results (not controlled for group level values of ses)</li>
<li>If on a school the average IQ is high, the effect of individual ses on the probability to get high test results are decreasing and vice versa</li>
</ul>
<ol start="10" type="1">
<li>a random intercept on school level and a random slope for IQ</li>
</ol>
<p>See <a href="#sec-slope.ex" class="quarto-xref"><span>Section 2.5.0.1</span></a> Random Slope Model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>m10 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_mean <span class="sc">+</span> IQ_verb <span class="sc">+</span>  (<span class="dv">1</span><span class="sc">+</span>IQ_verb<span class="sc">|</span>schoolnr),  <span class="co">#instead of an intercept (1), we insert IQ_verb as a random slope</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>DAT) </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m10)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_mean + IQ_verb + (1 + IQ_verb | schoolnr)
   Data: DAT

REML criterion at convergence: 22932.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2115 -0.6253  0.0740  0.7047  2.7517 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  9.3268  3.0540        
          IQ_verb      0.1896  0.4354   -0.62
 Residual             40.3709  6.3538        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
             Estimate Std. Error        df t value Pr(&gt;|t|)    
(Intercept)  41.03652    0.24111 202.40695 170.201  &lt; 2e-16 ***
IQ_mean       1.03026    0.26543 260.55139   3.882 0.000132 ***
IQ_verb       2.46418    0.06687 179.41415  36.852  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
        (Intr) IQ_men
IQ_mean -0.025       
IQ_verb -0.253 -0.197</code></pre>
</div>
</div>
<p>In this model not only the difference in the intercept is random, but also the slope. The slope is determined by the individual IQ, too.</p>
<p>This means, that not only the individual IQ and the IQ on school level has an effect on the test results, the effect of IQ has different effects on different classes.</p>
<p>If I had to choose for one of these models, I would go with the last one. For me, it is a bit neglectful to measure cross level interactions without taken individual effects for the explanatory variables and the group level effects into account. This is especially true for model 9. Model 6 give hints, that the individual effect of IQ is critical for better scores and is weakened by the the mean IQ. Consequently, to test, if the mean IQ is explanatory for better language test results without regarding the individual level appears a bit strange and contradictory. What assumptions should derive from that? That an overall higher IQ level in a school is a cause for better language tests for the individuals? It is a bit far away, to assume, that pupils with higher verbal IQs help the others out and therefore language test results are better for the pupils in the schools, than to assume, that the individual IQ level at a school and a school with a lot high level IQ pupils will have better test results than a school with less high level IQ pupils.</p>
<p>The last one has also the lowest variance in the residuals of random effects.</p>
<p>Another option is to compute random intercept models and random slope models, combining SES and IQ as explanatory variables. Like always, it depends on theory, which model makes sense and then test for statistical inference. For example behind model 4 lays the assumption, that if you have a higher ses, your IQ is less important for test results.</p>
</section>
</section>
<section id="statistical-testing" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="statistical-testing"><span class="header-section-number">2.7</span> Statistical Testing</h2>
<p>For the fixed parts, the <span class="math inline">\(\gamma\)</span> use the t-test with test statistic (compares the mean between groups):</p>
<p>The estimates comes from the sample data and are in consequence not the true scores → estimates are dependent on data and not taken for true</p>
<p><span class="math display">\[
T(γh) =
\frac{\hat{γ}}
{S.E.(\hat{γ}h)}
\]</span></p>
<p>(The F-test (test for variance between samples or groups) or Wald test for testing several parameters simultaneously.) The standard error should be based on REML estimation. → robust estimator and really recommended.</p>
<p>Degrees of freedom for the t-test / the denominator of the F-test</p>
<ul>
<li>For a level-1 variable: <span class="math inline">\(N − r − 1\)</span>, where N = total number of level-1 units, r = number of tested level-1 variables</li>
<li>For a level-2 variable: <span class="math inline">\(M − q − 1\)</span>, where M = number of level-2 units, q = number of tested level-2 variables</li>
<li>For a cross-level interaction: M − q − 1, where q = number of other level-2 variables interacting with the level-1 variable</li>
<li>Note: If d.f. ≥ 40, the t-distribution can be replaced by a standard normal</li>
</ul>
<p>→ the more variables I add, the less power my model is going to have</p>
<section id="exercise-4" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="exercise-4"><span class="header-section-number">2.7.1</span> Exercise</h3>
<p>Extended model like in the R script:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>mod7 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>                         IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>                         IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>                         IQ_mean<span class="sc">*</span>SES_mean <span class="sc">+</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>                         IQ_mean<span class="sc">*</span>IQ_verb <span class="sc">+</span> </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>                         SES_mean<span class="sc">*</span>ses <span class="sc">+</span> </span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                         IQ_mean<span class="sc">*</span>ses <span class="sc">+</span> </span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>                         SES_mean<span class="sc">*</span>IQ_verb <span class="sc">+</span>                          </span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">+</span> (IQ_verb<span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod7)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses +  
    IQ_mean * SES_mean + IQ_mean * IQ_verb + SES_mean * ses +  
    IQ_mean * ses + SES_mean * IQ_verb + +(IQ_verb | schoolnr)
   Data: DAT

REML criterion at convergence: 22763.1

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2346 -0.6159  0.0738  0.6964  2.8555 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  8.9260  2.9876        
          IQ_verb      0.1754  0.4189   -0.76
 Residual             38.0150  6.1656        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                   Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)       4.152e+01  2.669e-01  2.362e+02 155.570  &lt; 2e-16 ***
IQ_verb           2.217e+00  6.676e-02  1.957e+02  33.204  &lt; 2e-16 ***
ses               1.751e-01  1.253e-02  3.258e+03  13.978  &lt; 2e-16 ***
IQ_mean           7.868e-01  3.141e-01  2.356e+02   2.505  0.01292 *  
SES_mean         -8.495e-02  4.589e-02  2.353e+02  -1.851  0.06544 .  
IQ_verb:ses      -1.459e-02  6.690e-03  3.263e+03  -2.181  0.02925 *  
IQ_mean:SES_mean -1.227e-01  3.842e-02  4.195e+02  -3.194  0.00151 ** 
IQ_verb:IQ_mean  -5.289e-02  8.486e-02  2.332e+02  -0.623  0.53369    
ses:SES_mean      5.579e-04  2.315e-03  3.066e+03   0.241  0.80953    
ses:IQ_mean       1.154e-02  1.847e-02  3.343e+03   0.625  0.53224    
IQ_verb:SES_mean  7.266e-04  1.426e-02  3.081e+02   0.051  0.95941    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_vrb ses    IQ_men SES_mn IQ_vr: IQ_m:SES_ IQ_:IQ s:SES_
IQ_verb     -0.269                                                           
ses          0.036 -0.244                                                    
IQ_mean     -0.096 -0.176  0.051                                             
SES_mean     0.037  0.055 -0.267 -0.510                                      
IQ_verb:ses -0.131  0.042 -0.085  0.014 -0.004                               
IQ_mn:SES_m -0.327 -0.030  0.066  0.207 -0.022  0.136                        
IQ_vrb:IQ_m -0.097  0.028  0.027 -0.257  0.148 -0.002 -0.148                 
ses:SES_men -0.236 -0.009 -0.147  0.018  0.009  0.073 -0.076     0.152       
ses:IQ_mean  0.151  0.018 -0.047 -0.023  0.032 -0.310 -0.313    -0.222 -0.419
IQ_vrb:SES_  0.132  0.013  0.030  0.110 -0.245 -0.497 -0.105    -0.490 -0.238
            ss:IQ_
IQ_verb           
ses               
IQ_mean           
SES_mean          
IQ_verb:ses       
IQ_mn:SES_m       
IQ_vrb:IQ_m       
ses:SES_men       
ses:IQ_mean       
IQ_vrb:SES_  0.238</code></pre>
</div>
</div>
<ol type="1">
<li>&amp; 2. Based on a t-test: Which explanatory variables should stay in the model?, Based on a t-test: Which interaction effects should stay in the model?</li>
</ol>
<p>Significance indicated by p can be taken out of the models → using the p-values from the t-test.</p>
<p>The <code>lmertest</code> test the linear models and give the p-values for the explanatory variables. It computes for fixed effects the significance with t-tests. Looking at the results displayed in the summary the following variables and interaction effects should stay in the model:</p>
<p>effects on individual levels</p>
<ul>
<li>IQ_verb</li>
<li>ses</li>
</ul>
<p>effects - IQ_mean - SES_mean</p>
<p>cross-interaction effects: - IQ_verb:ses - IQ_mean:SES_mean</p>
<ol start="3" type="1">
<li>Reduce your model according to your findings.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>mod8 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>               IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>               IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>               IQ_mean<span class="sc">*</span>SES_mean <span class="sc">+</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>               (IQ_verb<span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod8)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses +  
    IQ_mean * SES_mean + (IQ_verb | schoolnr)
   Data: DAT

REML criterion at convergence: 22737.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2351 -0.6167  0.0817  0.6937  2.8556 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  8.9302  2.9883        
          IQ_verb      0.1683  0.4102   -0.77
 Residual             37.9938  6.1639        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                   Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)       4.151e+01  2.582e-01  2.093e+02 160.802  &lt; 2e-16 ***
IQ_verb           2.217e+00  6.638e-02  1.982e+02  33.403  &lt; 2e-16 ***
ses               1.770e-01  1.228e-02  3.242e+03  14.418  &lt; 2e-16 ***
IQ_mean           7.452e-01  3.027e-01  2.203e+02   2.462 0.014580 *  
SES_mean         -8.549e-02  4.429e-02  2.519e+02  -1.930 0.054699 .  
IQ_verb:ses      -1.439e-02  5.171e-03  9.880e+02  -2.783 0.005491 ** 
IQ_mean:SES_mean -1.164e-01  3.378e-02  2.680e+02  -3.445 0.000662 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_vrb ses    IQ_men SES_mn IQ_vr:
IQ_verb     -0.278                                   
ses          0.008 -0.251                            
IQ_mean     -0.113 -0.174  0.062                     
SES_mean     0.060  0.057 -0.273 -0.504              
IQ_verb:ses -0.096  0.084 -0.122 -0.016 -0.127       
IQ_mn:SES_m -0.383 -0.014  0.024  0.173 -0.014 -0.133</code></pre>
</div>
</div>
<p>In the reduced model all variables are still significant. SES_mean has only a significance level of 0.055, so we could think about kicking it out.</p>
<p>→ The individual IQ has a positive, significant effect on the score. If the IQ is one point higher, the language score result will probably increase by 2.17. Also the ses has a positive, significant effect on the score.If the ses increase by one point, it increase 0.17.</p>
<p>→ If the average IQ on a school is higher, than the language score test are probably higher, too. And if the average SES is higher on a school, the score will increase, too.</p>
<p>→ There is an interaction effect between IQ and ses on individual and school level: The positive, significant effect of IQ is damped by the ses or vice versa. A low level in ses dampens the positive effect of an high IQ on a language test score. OR: A higher level in ses compensate low levels in IQ.</p>
<p>→ There is also an interaction effect on the school level. This could be, because of the strong correlation between the IQ_mean and SES_mean.</p>
<p>Model 8 has compared to all other models the smallest variance on school level and in the residuals and consequently, will have the a higher ICC than the other models.</p>
</section>
</section>
<section id="testing-random-effects-with-the-lieklihood-ratio-test-lrt" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="testing-random-effects-with-the-lieklihood-ratio-test-lrt"><span class="header-section-number">2.8</span> Testing random effects with the lieklihood-ratio test (LRT)</h2>
<p>Difference between linear regression and HLM is in the <span class="math inline">\(U_{ij}\)</span>, the <span class="math inline">\(\tau^2\)</span></p>
<ul>
<li><p>Assesses goodness of fit of two nested statistical models (model 1 and model 2) based on the ratio of their likelihoods</p></li>
<li><p>Models are considered as <a href="https://joshuawiley.com/MonashHonoursStatistics/LMM_Comparison.html">nested</a>, when one model is a restricted or constrained version of another model</p></li>
<li><p>Data is fixed, we can compute different models. The likelihood Λ gives the probability that the parameters fits the distribution of the sample, comparing different models</p></li>
<li><p>Model 2 has parameter space <span class="math inline">\(θ\)</span> ∈ <span class="math inline">\(Θ\)</span>, with <span class="math inline">\(θ\)</span> is unknown / to be estimated</p>
<ul>
<li>H0: <span class="math inline">\(Θ\)</span> (the complexer model 2) is in subset <span class="math inline">\(Θ_0\)</span> of <span class="math inline">\(Θ\)</span><br>
</li>
<li>Simpler model 1 has parameter space <span class="math inline">\(Θ_0\)</span>, more complex model 2 parameter space <span class="math inline">\(Θ\)</span></li>
<li>Null Hypothesis: Model 2 are a subset of the linear regression, therefore model 2 and <span class="math inline">\(U_{ij}\)</span> is not necessary → the more complexer model is equal to the simpler model</li>
<li>More complex model 2 can be transformed into simpler model 1 by imposing constraints on model’s 2 parameters: model 1 is nested in model 2 → model 1 is nested into model 2, while model 2 is tested, because in model 1 are parameters set to 0 and consequently its simpler</li>
</ul></li>
<li><p>Usually: model 2 found by maximization over the entire parameter space and model 1 found after imposing some constraint</p></li>
</ul>
<p>→ key question: what is tested (model 2) and what is nested (model 1)?</p>
<p>Note: Model 1 doesn’t have to be a linear regression, could also be a simpler HLM compared to a more complex model 2</p>
<p>Note: If two models are nested, then we have the most options in terms of comparing the two models. For example, we can evaluate whether Model A is a statistically significantly better fit than is Model B using a <a href="https://joshuawiley.com/MonashHonoursStatistics/LMM_Comparison.html"><strong>Likelihood Ratio Test (LRT)</strong></a></p>
<ul>
<li>LR test tests whether related likelihood ratio is significantly different from one</li>
<li>LR test statistic is the deviance difference:</li>
</ul>
<p><span class="math display">\[
λ_{LR} = −2 ln
\frac{supθ∈Θ0Λ(θ)}
{supθ∈ΘΛ(θ)}
\]</span></p>
<p><span class="math display">\[
λ_{LR} = −2[l(θ_0) − l\hat{θ})]
\]</span></p>
<p>where <span class="math inline">\(l(\hatθ)\)</span> is the logarithm of the maximized likelihood function <span class="math inline">\(Λ\)</span> (under model 2), and <span class="math inline">\(l(θ_0)\)</span> is the maximal value if H0 is true (i.e.&nbsp;under model 1).</p>
<p>Higher likelihood means better fit of the data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.likelihood.png" class="img-fluid figure-img" width="300"></p>
<figcaption>Likelihoood Ratio</figcaption>
</figure>
</div>
<p>The deviance difference is the difference between the highest points between the two curves. In this case it is 2. If the difference is zero, we don’t need the more complex model and can reject H0.</p>
<p>H0 is true means that model 2 (tested model) is not sign. better in fitting the data than model 1 (nested model).</p>
<p>Multiplication with −2 ensures <span class="math inline">\(λ_{LR}\)</span> assym. converges to <span class="math inline">\(χ^2\)</span> distribution under H0</p>
<p>Small p-value (related to <span class="math inline">\(χ^2\)</span> distr.) indicates that H0 is wrong, i.e.&nbsp;evidence for model 2</p>
<section id="deviances-and-lambda_lr" class="level4" data-number="2.8.0.1">
<h4 data-number="2.8.0.1" class="anchored" data-anchor-id="deviances-and-lambda_lr"><span class="header-section-number">2.8.0.1</span> Deviances and <span class="math inline">\(\lambda_{LR}\)</span></h4>
<p>We have (with <span class="math inline">\(\hat{θ}\)</span> denotes the fitted parameters for the saturated model(include more or too much parameter):</p>
<ul>
<li>Deviance model 1: <span class="math inline">\(D1 = −2(l(\hatθ_s ) − l(\hatθ_1))\)</span> with <span class="math inline">\(\hatθ_1\)</span> fitted parameters of model 1, <span class="math inline">\(|θ_1 = m1\)</span></li>
<li>Deviance model 2: <span class="math inline">\(D2 = −2(l(\hatθ_s ) − l(\hatθ_2))\)</span> with <span class="math inline">\(\hatθ_2\)</span> fitted parameters of model 2, $|θ_2| = m2, m1 &lt; m2 $</li>
</ul>
<p>Then: The test statistic for testing model 2 against model 1 is:</p>
<p><span class="math display">\[
\hat{\lambda}_{LR} = −2(l(\hatθ_2) − l(\hatθ_1)) = D1 − D2
\]</span></p>
<p>When the deviance is zero or near to zero, we don’t need a multilevel model.</p>
<p>If the null hypothesis of no difference is true in the population, then <span class="math inline">\(λ\)</span> will follow a chi-squared distribution with degrees of freedom equal to the number of parameters constrained to 0 in Model 1 from Model 2, the difference in degrees of freedom used for each model, that is:</p>
<p><span class="math display">\[
\lambda  \sim \chi^2(df1-df2)
\]</span></p>
<p>Thus we often use a chi-square distribution in the LRT to look up the p-value. Finally, note that because LRTs are based on the log likelihoods (LL) from a model, we need true log likelihoods for the LRT to be valid. Therefore, we cannot use restricted maximum likelihood, we need to use maximum likelihood estimation.</p>
<p>One special circumstance: variance parameters are necessarily positive. Therefore, they may be tested <strong>one-sided.</strong></p>
<p>E.g., in the random intercept model: <span class="math inline">\(H_0 : τ^ 2_0 = 0\)</span> Asymptotic distribution of the deviance difference is a mixture of a point mass at 0 (with prob. 0.5) and a <span class="math inline">\(χ^2\)</span> [<a href="https://studyflix.de/mathematik/chi-quadrat-verteilung-1090">distribution</a> (with prob. 0.5) Interpretation: if observed between-group variance ≤ as expected under H0 (which happens with prob 0.5) the estimate is <span class="math inline">\(τ6 2 0 = 0\)</span> and the log-likelihood ratio is 0 The test works as follows:</p>
<ul>
<li>if deviance difference <span class="math inline">\(= 0\)</span>: no significance</li>
<li>if deviance difference <span class="math inline">\(&gt; 0\)</span>: calculate p-value from <span class="math inline">\(X^2_1\)</span> and divide by 2</li>
</ul>
<p><em>d</em> stands for the degrees of freedom → the parameters you have added</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.x2.png" class="img-fluid figure-img" width="200"></p>
<figcaption>chisquared distribution</figcaption>
</figure>
</div>
</section>
</section>
<section id="random-slope-variances" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="random-slope-variances"><span class="header-section-number">2.9</span> Random Slope Variances</h2>
<p>As before: LR test Number of tested parameters (variances &amp; covariances): <span class="math inline">\(d + 1\)</span> → because another parameter is added to model 2</p>
<p>E.g.: testing for a random slope in a model that further contains the random intercept but no other random slopes: <span class="math inline">\(d = 1\)</span></p>
<ul>
<li>p-values can be obtained as the average of the p-values for the <span class="math inline">\(χ^2_d\)</span> and <span class="math inline">\(χ^2_{d+1}\)</span> distributions</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.p-value.png" class="img-fluid figure-img" width="200"></p>
<figcaption>P-values for random slopes</figcaption>
</figure>
</div>
<section id="exercise-5" class="level4" data-number="2.9.0.1">
<h4 data-number="2.9.0.1" class="anchored" data-anchor-id="exercise-5"><span class="header-section-number">2.9.0.1</span> Exercise</h4>
<p>Data (as before) Tasks: Which model does give the better model fit? Test it!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Linear Model, simple model</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>mod9a <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>               IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>               IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>               IQ_mean<span class="sc">*</span>SES_mean, <span class="at">data=</span>DAT)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod9a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + 
    IQ_verb * ses + IQ_mean * SES_mean, data = DAT)

Residuals:
     Min       1Q   Median       3Q      Max 
-30.0910  -4.4280   0.6795   4.8196  24.0581 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      41.580399   0.129703 320.583  &lt; 2e-16 ***
IQ_verb           2.194084   0.065389  33.554  &lt; 2e-16 ***
ses               0.176449   0.013577  12.996  &lt; 2e-16 ***
IQ_mean           0.962597   0.176064   5.467 4.89e-08 ***
SES_mean         -0.099739   0.025883  -3.853 0.000119 ***
IQ_verb:ses      -0.013872   0.005336  -2.600 0.009375 ** 
IQ_mean:SES_mean -0.099846   0.019623  -5.088 3.81e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6.852 on 3447 degrees of freedom
Multiple R-squared:  0.4135,    Adjusted R-squared:  0.4125 
F-statistic: 405.1 on 6 and 3447 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Random Intercept, more complex model</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>mod9b <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>               IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>               IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>               IQ_mean<span class="sc">*</span>SES_mean <span class="sc">+</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod9b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses +  
    IQ_mean * SES_mean + (1 | schoolnr)
   Data: DAT

REML criterion at convergence: 22761.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2028 -0.6359  0.0735  0.6928  3.1440 

Random effects:
 Groups   Name        Variance Std.Dev.
 schoolnr (Intercept)  8.655   2.942   
 Residual             38.645   6.217   
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                   Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)       4.143e+01  2.550e-01  2.034e+02 162.453  &lt; 2e-16 ***
IQ_verb           2.193e+00  5.933e-02  3.239e+03  36.965  &lt; 2e-16 ***
ses               1.767e-01  1.232e-02  3.239e+03  14.340  &lt; 2e-16 ***
IQ_mean           9.135e-01  3.153e-01  2.284e+02   2.898  0.00413 ** 
SES_mean         -9.145e-02  4.538e-02  2.345e+02  -2.015  0.04502 *  
IQ_verb:ses      -1.463e-02  4.929e-03  3.302e+03  -2.969  0.00301 ** 
IQ_mean:SES_mean -8.972e-02  3.325e-02  2.620e+02  -2.699  0.00742 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_vrb ses    IQ_men SES_mn IQ_vr:
IQ_verb     -0.009                                   
ses          0.010 -0.282                            
IQ_mean     -0.117 -0.187  0.051                     
SES_mean     0.028  0.075 -0.269 -0.494              
IQ_verb:ses -0.092  0.096 -0.114 -0.002  0.013       
IQ_mn:SES_m -0.381 -0.014  0.016  0.277  0.020 -0.144</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#, Random Slope, most complex model</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>mod9c <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>               IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>               IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>               IQ_mean<span class="sc">*</span>SES_mean <span class="sc">+</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>               (IQ_verb<span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod9c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses +  
    IQ_mean * SES_mean + (IQ_verb | schoolnr)
   Data: DAT

REML criterion at convergence: 22737.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2351 -0.6167  0.0817  0.6937  2.8556 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  8.9302  2.9883        
          IQ_verb      0.1683  0.4102   -0.77
 Residual             37.9938  6.1639        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                   Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)       4.151e+01  2.582e-01  2.093e+02 160.802  &lt; 2e-16 ***
IQ_verb           2.217e+00  6.638e-02  1.982e+02  33.403  &lt; 2e-16 ***
ses               1.770e-01  1.228e-02  3.242e+03  14.418  &lt; 2e-16 ***
IQ_mean           7.452e-01  3.027e-01  2.203e+02   2.462 0.014580 *  
SES_mean         -8.549e-02  4.429e-02  2.519e+02  -1.930 0.054699 .  
IQ_verb:ses      -1.439e-02  5.171e-03  9.880e+02  -2.783 0.005491 ** 
IQ_mean:SES_mean -1.164e-01  3.378e-02  2.680e+02  -3.445 0.000662 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_vrb ses    IQ_men SES_mn IQ_vr:
IQ_verb     -0.278                                   
ses          0.008 -0.251                            
IQ_mean     -0.113 -0.174  0.062                     
SES_mean     0.060  0.057 -0.273 -0.504              
IQ_verb:ses -0.096  0.084 -0.122 -0.016 -0.127       
IQ_mn:SES_m -0.383 -0.014  0.024  0.173 -0.014 -0.133</code></pre>
</div>
</div>
<p>The following steps for LRT are from this <a href="https://joshuawiley.com/MonashHonoursStatistics/LMM_Comparison.html#non-nested-models">website</a></p>
<p>Check that all models are fitted to the same data and the same observations are included:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nobs</span>(mod9a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3454</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nobs</span>(mod9b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3454</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nobs</span>(mod9c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3454</code></pre>
</div>
</div>
<p>Get the log Likelihoods for the models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(mod9a) <span class="co"># simple model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -11545.01 (df=8)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(mod9b) <span class="co"># more complex model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -11380.82 (df=9)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(mod9c) <span class="co"># most complex model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -11368.69 (df=11)</code></pre>
</div>
</div>
<p>Compute lambda for mod9a and mod9b</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">#lamdba for more complex model (nested) and most complex model (tested)</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="dv">2</span><span class="sc">*</span> (<span class="sc">-</span><span class="fl">11545.01</span> <span class="sc">-</span> <span class="sc">-</span><span class="fl">11368.69</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 352.64</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value from a chi-square</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>(<span class="fl">352.64</span>, <span class="at">df=</span> <span class="dv">1</span>, <span class="at">lower.tail=</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.127842e-78</code></pre>
</div>
</div>
<p>→ reject the H0, go with the more complex model</p>
<p>Compute lambda for mod9b and mod9c</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#lamdba for more complex model (nested) and most complex model (tested)</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span><span class="dv">2</span><span class="sc">*</span> (<span class="sc">-</span><span class="fl">11380.82</span> <span class="sc">-</span> <span class="sc">-</span><span class="fl">11368.69</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.26</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value from a chi-square, in this case 2 df, because model 9b has 9 and model 9c has 11</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>(<span class="fl">24.26</span>, <span class="at">df=</span> <span class="dv">2</span>, <span class="at">lower.tail=</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.395205e-06</code></pre>
</div>
</div>
<p>→ also in this case reject the H0, go with the more complex model</p>
<p>In practice, we don’t have to do it by hand, we can use the <code>ranova</code> function.</p>
<p>The first test compares the reduction from the random intercept to not include a random intercept like in mod9a, the random intercept is removed (see for details the description for the <a href="https://www.rdocumentation.org/packages/lmerTest/versions/3.1-3/topics/ranova"><code>ranova</code> function</a>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ranova</span>(mod9b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ANOVA-like table for random-effects: Single term deletions

Model:
langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + (1 | schoolnr) + IQ_verb:ses + IQ_mean:SES_mean
               npar logLik   AIC    LRT Df Pr(&gt;Chisq)    
&lt;none&gt;            9 -11381 22780                         
(1 | schoolnr)    8 -11563 23142 363.96  1  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ranova</span>(mod9c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ANOVA-like table for random-effects: Single term deletions

Model:
langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + (IQ_verb | schoolnr) + IQ_verb:ses + IQ_mean:SES_mean
                                npar logLik   AIC   LRT Df Pr(&gt;Chisq)    
&lt;none&gt;                            11 -11369 22759                        
IQ_verb in (IQ_verb | schoolnr)    9 -11381 22780 24.27  2  5.368e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">#other option:</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(mod9b, mod9c, <span class="at">refit=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: DAT
Models:
mod9b: langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses + IQ_mean * SES_mean + (1 | schoolnr)
mod9c: langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses + IQ_mean * SES_mean + (IQ_verb | schoolnr)
      npar   AIC   BIC logLik deviance Chisq Df Pr(&gt;Chisq)    
mod9b    9 22780 22835 -11381    22762                        
mod9c   11 22759 22827 -11369    22737 24.27  2  5.368e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>→ also in this case reject the H0, go with the most complex model</p>
</section>
</section>
<section id="explained-variance" class="level2" data-number="2.10">
<h2 data-number="2.10" class="anchored" data-anchor-id="explained-variance"><span class="header-section-number">2.10</span> Explained Variance</h2>
<p>In ordinary linear models we compute <span class="math inline">\(R^2\)</span> for model <span class="math inline">\(ω\)</span> as the proportionate reduction in the RSS (residual sum of squares) starting from the null model <span class="math inline">\(ϕ\)</span>:</p>
<p><span class="math display">\[
R2 = 1 − \frac{RSS(ω)}{RSS(ϕ)}
\]</span></p>
<p>In a two level random intercept model we can define <span class="math inline">\(R^2\)</span> (with a total model variance of <span class="math inline">\(σ^2 + τ^2_0\)</span>):</p>
<p><span class="math display">\[
R^2 = 1 − \frac{\hatσ^2(ω) + τ^2_0(ω)}{\hatσ^2(ϕ) + τ^2_0(ϕ)}
\]</span></p>
<p>This can also be calculated by level:</p>
<p>For macro level 2:</p>
<p><span class="math display">\[
R^2_{L2}= 1- \frac{ τ^2_0(ω)}{ τ^2_0(ϕ)}
\]</span> For micro level 1:</p>
<p><span class="math display">\[
R^2_{L1} = 1 − \frac{\hatσ^2(ω) }{\hatσ^2(ϕ) }
\]</span> <em>Note</em>: Unlike linear models R2 is not guaranteed to increase when variables are added!</p>
<section id="exercise-6" class="level3" data-number="2.10.1">
<h3 data-number="2.10.1" class="anchored" data-anchor-id="exercise-6"><span class="header-section-number">2.10.1</span> Exercise</h3>
<p>You have the following models and the related variance estimates: Note: Model A. corresponds to the null model; Model D. to the substantial model.</p>
<p><img src="figures/1.ex-rss.png" class="img-fluid" width="200"></p>
<p>Compute <span class="math inline">\(R^2\)</span>, <span class="math inline">\(R^2_{L1}\)</span>, <span class="math inline">\(R^2_{L2}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Level 1</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> (<span class="fl">6.973</span><span class="sc">/</span><span class="fl">8.694</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1979526</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Level 2</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> (<span class="fl">0.991</span><span class="sc">/</span><span class="fl">2.271</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5636284</code></pre>
</div>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R2</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> ((<span class="fl">6.973+0.991</span>)<span class="sc">/</span>(<span class="fl">8.694+2.271</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.273689</code></pre>
</div>
</div>
<p>Other way to do it in R is with</p>
<pre><code>library(mitml)
multilevelR2(mod, print=c("RB1",  #explained variance on level 1
"RB2", #explained variance on level 2 both according to Raudenbuch and Bryk (2002, pp. 74 and 79)
"SB", #total variance explained according ot Snijders and Bosker (2012, p.112)
MVP") #total variance explained based on multilevel variance partioning by LaHUis, Hakoyama and Clark (2014)</code></pre>
</section>
</section>
<section id="heteroscedasticity" class="level2" data-number="2.11">
<h2 data-number="2.11" class="anchored" data-anchor-id="heteroscedasticity"><span class="header-section-number">2.11</span> Heteroscedasticity</h2>
<p>Heteroscedasticity can be modelled in ML-Models, i.e.&nbsp;residual variance depends on observed variables.</p>
<p>E.g., random part at level one <span class="math inline">\(= R_{0ij} + R_{1ij}x_{1ij}\)</span></p>
<p>Here the level-1 variance is a quadratic function of <span class="math inline">\(X\)</span>:</p>
<p><span class="math display">\[
var (R_{0ij} + R_{1ij}x_{1ij} ) = σ^2_0 + 2σ_{01}x_{1ij} + σ^2_1x^2_{1ij}
\]</span></p>
<p>For <span class="math inline">\(σ^21 = 0\)</span>, this is a linear function:</p>
<p><span class="math display">\[
var (R_{0ij} + R_{1ij}x_{1ij} ) = σ^2_0 + 2σ_{01}x_{1ij}
\]</span></p>
<p>This is possible as a variance function, without random effects interpretation.</p>
<p><em>Example</em>:</p>
<p>You find <span class="math inline">\(\hatσ^2_0=σ 37.85\)</span> and <span class="math inline">\(\hatσ_{01} = −1.89\)</span> is a gender effect on the variance term</p>
<p>Then: The estimated residual (level-1) variance is 37.85 for boys and <span class="math inline">\(37.85 − 2 × 1.89 = 34.07\)</span> for girls</p>
<p><em>Example in R:</em></p>
<p>Heteroscedasticity with respect to IQ:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'nlme'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    collapse</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:lme4':

    lmList</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lme</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>               IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>               IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>               IQ_mean<span class="sc">*</span>SES_mean,</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="at">data=</span>DAT,<span class="at">random =</span> <span class="sc">~</span> IQ_verb<span class="sc">|</span>schoolnr,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="at">weights=</span><span class="fu">varFixed</span>(<span class="sc">~</span>IQ_verb))</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: DAT 
       AIC      BIC    logLik
  24609.84 24677.44 -12293.92

Random effects:
 Formula: ~IQ_verb | schoolnr
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev       Corr  
(Intercept) 3.3536284565 (Intr)
IQ_verb     0.0008512364 -0.002
Residual    8.0814117189       

Variance function:
 Structure: fixed weights
 Formula: ~IQ_verb 
Fixed effects:  langPOST ~ IQ_verb + ses + IQ_mean + SES_mean + IQ_verb * ses +      IQ_mean * SES_mean 
                    Value Std.Error   DF   t-value p-value
(Intercept)      41.62918 0.2850563 3240 146.03844  0.0000
IQ_verb           2.38666 0.1151238 3240  20.73127  0.0000
ses               0.18968 0.0118918 3240  15.95052  0.0000
IQ_mean           0.98568 0.3588633  207   2.74668  0.0066
SES_mean         -0.11226 0.0505054  207  -2.22278  0.0273
IQ_verb:ses      -0.01506 0.0101003 3240  -1.49149  0.1359
IQ_mean:SES_mean -0.10614 0.0404586  207  -2.62332  0.0094
 Correlation: 
                 (Intr) IQ_vrb ses    IQ_men SES_mn IQ_vr:
IQ_verb          -0.018                                   
ses               0.005 -0.143                            
IQ_mean          -0.104 -0.100  0.036                     
SES_mean          0.026  0.036 -0.235 -0.497              
IQ_verb:ses      -0.042  0.047 -0.085  0.011  0.004       
IQ_mean:SES_mean -0.398  0.008 -0.001  0.202  0.036 -0.076

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-6.64829880 -0.48269019  0.02393963  0.51663401  4.29185099 

Number of Observations: 3454
Number of Groups: 211 </code></pre>
</div>
</div>
<p><em>Note:</em> From lme function’s help: weights: one-sided formula describing the within-group heteroscedasticity structure.</p>
</section>
<section id="diagnostics" class="level2" data-number="2.12">
<h2 data-number="2.12" class="anchored" data-anchor-id="diagnostics"><span class="header-section-number">2.12</span> Diagnostics</h2>
<p><span class="math display">\[
Y_{ij} = γ_0 + \sum_{h=1}^r \gamma_h x_{hij} + U_{0j} +\sum_{h=1}^p U_{hj}x_{hij} + R_{ij}
\]</span></p>
<p><strong>What has to be checked:</strong> - Does the fixed part contain the right variables? → Test effects and group means - Does the random part contain the right variables? → Test effects and group means - Are the level-1 residuals normally distributed? →Level-1 residual analysis - Do the level-1 residuals have constant variance ?→ Study heteroscedasticity - Are the level-2 random coefficients normally distributed with mean 0? → Level-2 residual analysis and level-1 residual analysis, - Do the level-2 random coefficients have a constant covariance matrix? → Level-2 residual analysis</p>
<section id="are-there-contextual-effects-not-considered-test-effects-and-group-means" class="level3" data-number="2.12.1">
<h3 data-number="2.12.1" class="anchored" data-anchor-id="are-there-contextual-effects-not-considered-test-effects-and-group-means"><span class="header-section-number">2.12.1</span> Are there contextual effects not considered? Test effects and group means</h3>
<ul>
<li>For every level-1 variable <span class="math inline">\(X_h\)</span> check the fixed effect of the group mean <span class="math inline">\(\overline{X}_h\)</span>.</li>
<li><span class="math inline">\(U_0j\)</span> must not be correlated with the <span class="math inline">\(X_{hij}\)</span> + Include the fixed effect of <span class="math inline">\(X_h\)</span> if it is significant, and continue to use a random effects model. (Also check effects of variables <span class="math inline">\(X_h·_jZ_j\)</span> for cross-level interactions involving <span class="math inline">\(X_h\)</span>) + Random slopes <span class="math inline">\(U_hj\)</span> must not be correlated with the <span class="math inline">\(X_{kij}\)</span> → This can be checked by testing the fixed effect of <span class="math inline">\(X_{k·j}X_{hij}\)</span></li>
</ul>
</section>
<section id="level-1-residual-analysis" class="level3" data-number="2.12.2">
<h3 data-number="2.12.2" class="anchored" data-anchor-id="level-1-residual-analysis"><span class="header-section-number">2.12.2</span> Level-1 residual analysis</h3>
<p>Level-1 specification can be studied by disaggregation to the within-group level</p>
<ul>
<li>Test the fixed part of the level-1 model using OLS level-1 residuals, calculated per group separately</li>
<li>Test the random part of the level-1 model using squared standardized OLS residuals (check for homoscedasticity)</li>
</ul>
<p><em>Note:</em> The construction of the OLS within-group residuals implies that this tests only the level-one specification, independent of the correctness of the level-2 specification</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.level1res.png" class="img-fluid figure-img" width="500"></p>
<figcaption>level-1 residual analysis</figcaption>
</figure>
</div>
<section id="exercise-7" class="level4" data-number="2.12.2.1">
<h4 data-number="2.12.2.1" class="anchored" data-anchor-id="exercise-7"><span class="header-section-number">2.12.2.1</span> Exercise:</h4>
<p>Model: We have the following 2-level Model:</p>
<ul>
<li>with IQ, SES, gender, IQ, SES as explanatory variables</li>
<li>with an interaction effect between IQ and SES</li>
<li>with a random intercept for the school level and a random slope for IQ</li>
</ul>
<p>Task: Conduct Level-1 residual analysis for that model</p>
<p>Estimate the related within model and extract the residuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>DAT_w <span class="ot">&lt;-</span> DAT <span class="co">#create a new data set </span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get all the residuals for the fixed parts of level 1 by substracting the individual score from the group mean</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>DAT_w<span class="sc">$</span>IQ_verb <span class="ot">&lt;-</span> DAT_w<span class="sc">$</span>IQ_verb <span class="sc">-</span> <span class="fu">mean</span>(DAT_w<span class="sc">$</span>IQ_verb)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>DAT_w<span class="sc">$</span>langPOST <span class="ot">&lt;-</span> DAT_w<span class="sc">$</span>langPOST <span class="sc">-</span> <span class="fu">mean</span>(DAT_w<span class="sc">$</span>langPOST)</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>DAT_w<span class="sc">$</span>ses <span class="ot">&lt;-</span> DAT_w<span class="sc">$</span>ses <span class="sc">-</span> <span class="fu">mean</span>(DAT_w<span class="sc">$</span>ses) </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a><span class="co"># test the random part of level-1 model by using squared standardized OLS residuals and get the residuals</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>res_w <span class="ot">&lt;-</span> <span class="fu">lm</span>(langPOST <span class="sc">~</span> IQ_verb <span class="sc">+</span> ses <span class="sc">+</span> sex <span class="sc">+</span> IQ_verb<span class="sc">*</span>ses, <span class="at">data=</span>DAT_w)<span class="sc">$</span>residuals</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res_w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-28.9569  -4.2417   0.5021   0.0000   4.8489  24.5437 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the rounded values for IQ_verb residuals from the minimum to the maximum</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(<span class="fu">round</span>(DAT_w<span class="sc">$</span>IQ_verb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -8  7</code></pre>
</div>
</div>
<p>Study the residuals in comparison to the related IQ value, by forming mean residuals in IQ categories and by plotting. Add to each mean residual in each IQ category formed a measure of uncertainty, e.g.&nbsp;± twice the std. dev. of the estimated mean residual Hint: Use R code snippets given at the next slide.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>RES <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iq <span class="cf">in</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="sc">-</span><span class="dv">8</span>, <span class="at">to=</span><span class="dv">7</span>, <span class="at">by=</span><span class="fl">0.5</span>)){</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  res_cat <span class="ot">&lt;-</span> res_w[DAT_w<span class="sc">$</span>IQ_verb <span class="sc">&gt;=</span> iq <span class="sc">&amp;</span> DAT_w<span class="sc">$</span>IQ_verb <span class="sc">&lt;=</span> (iq<span class="sc">+</span><span class="dv">1</span>)]</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  RES <span class="ot">&lt;-</span> <span class="fu">rbind</span>(RES, <span class="fu">c</span>(iq, <span class="fu">mean</span>(res_cat), <span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">var</span>(res_cat)<span class="sc">/</span><span class="fu">length</span>(res_cat))))</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RES[,<span class="dv">1</span>], RES[,<span class="dv">2</span>], <span class="at">pch=</span><span class="dv">20</span>, <span class="at">xlab=</span><span class="st">"IQ"</span>, <span class="at">ylab=</span><span class="st">"mean residual (IQ categ.)"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">3</span>))</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(RES)){</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="fu">rep</span>(RES[i,<span class="dv">1</span>],<span class="dv">2</span>), <span class="fu">c</span>(RES[i,<span class="dv">2</span>]<span class="sc">-</span>RES[i,<span class="dv">3</span>], RES[i,<span class="dv">2</span>]<span class="sc">+</span>RES[i,<span class="dv">3</span>]))</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>What do you see? What do you conclude?</p>
<p>The first plot shows a curvilinear effect of IQ, which indicates that the assumption of heteroskedasticity is violated.</p>
<p><strong>Task</strong>: Check normality of the residuals using a normal probability plot of standardized level-1 OLS residuals What do you conclude? For Standardizing: divide residuals by their standard derivation (function sd in R) Use the R function <code>qqnorm</code> and <code>qqline</code> for that task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>res_std_w <span class="ot">&lt;-</span> res_w<span class="sc">/</span><span class="fu">sd</span>(res_w)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(res_std_w)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(res_std_w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The normal Q-Q Plot shows, that while there is a normal line to the center, on the tails end especially in the lower end there is a higher deviation, what could be a sign for heteroskedasticity.</p>
<p>If the assumption of homoskedasticity is violated, transform! More infomormation <a href="https://ademos.people.uic.edu/Chapter18.html#62_assumption_2_homogeneity_of_variance">here!</a></p>
<p><strong>or use a quadric</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/1.level1quad.png" class="img-fluid figure-img" width="600"></p>
<figcaption>quadric IQ</figcaption>
</figure>
</div>
</section>
</section>
<section id="level-2-residual-analysis" class="level3" data-number="2.12.3">
<h3 data-number="2.12.3" class="anchored" data-anchor-id="level-2-residual-analysis"><span class="header-section-number">2.12.3</span> Level-2 residual analysis</h3>
<p>Estimated level-2 residuals are always confounded with the estimated level-1 residuals:</p>
<ul>
<li>first conduct level-1 residual analysis, then conduct level-2 residual analysis</li>
<li>For level-2 residual analysis use the empirical Bayes estimates of the level-2 random effects (i.e., used as level-2 residuals)</li>
<li>E.g.: plot unstd. level-2 residuals as a function of relevant level-2 variables to check for possible nonlinearity</li>
<li>Normal probability plots may be made by std. level-2 residuals</li>
<li>Squared residuals may be plot as a function of level-2 variables to check for homoscedasticity</li>
<li><em>Note</em>: Deviation from normality at level-2 might also be caused by an incorrect specification of fixed effects</li>
</ul>
<section id="exercise-8" class="level4" data-number="2.12.3.1">
<h4 data-number="2.12.3.1" class="anchored" data-anchor-id="exercise-8"><span class="header-section-number">2.12.3.1</span> Exercise</h4>
<p><strong>Model</strong>: We have the following 2-level Model:</p>
<ul>
<li>with IQ, IQ2−, IQ2+ , SES, gender, <span class="math inline">\(\overline{IQ}\)</span>, <span class="math inline">\(\overline{SES}\)</span> as explanatory variables</li>
<li>with an interaction effect between IQ and SES</li>
<li>with an interaction effect between <span class="math inline">\(\overline{IQ}\)</span> and <span class="math inline">\(\overline{SES}\)</span></li>
<li>with a random intercept for the school level and a random slope for IQ</li>
</ul>
<p><strong>Task:</strong> Conduct Level-2 residual analysis for that model Estimate the related within model and extract the level-2 residuals (Mind that these residuals can be described by the estimated random effects)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">#compute IQ squared minus and IQ squared plus to have homoskedasticity</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>?ifelse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Help on topic 'ifelse' was found in the following packages:

  Package               Library
  base                  /home/runner/.cache/R/renv/sandbox/R-4.3/x86_64-pc-linux-gnu/5cd49154
  data.table            /home/runner/work/_temp/renv/cache/v5/R-4.3/x86_64-pc-linux-gnu/data.table/1.16.4/38bbf05fc2503143db4c734a7e5cab66


Using the first match ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>DAT<span class="sc">$</span>IQsq_min <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(DAT<span class="sc">$</span>IQ_verb<span class="sc">&lt;</span><span class="dv">0</span>, DAT<span class="sc">$</span>IQ_verb<span class="sc">^</span><span class="dv">2</span>, <span class="dv">0</span>)</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>DAT<span class="sc">$</span>IQsq_pl <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(DAT<span class="sc">$</span>IQ_verb<span class="sc">&lt;</span><span class="dv">0</span>, <span class="dv">0</span>, DAT<span class="sc">$</span>IQ_verb<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co">#create a model including this new variables</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>mod10 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(langPOST <span class="sc">~</span>  IQ_verb <span class="sc">+</span> IQsq_min <span class="sc">+</span> IQsq_pl <span class="sc">+</span> ses <span class="sc">+</span> </span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>                IQ_mean <span class="sc">+</span> SES_mean <span class="sc">+</span>  </span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>                IQ_verb<span class="sc">*</span>ses <span class="sc">+</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>                IQ_mean<span class="sc">*</span>SES_mean <span class="sc">+</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>                (IQ_verb<span class="sc">|</span>schoolnr), <span class="at">data=</span>DAT)</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod10)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: langPOST ~ IQ_verb + IQsq_min + IQsq_pl + ses + IQ_mean + SES_mean +  
    IQ_verb * ses + IQ_mean * SES_mean + (IQ_verb | schoolnr)
   Data: DAT

REML criterion at convergence: 22700.2

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.2420 -0.6253  0.0960  0.6870  2.9187 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 schoolnr (Intercept)  8.717   2.9525        
          IQ_verb      0.113   0.3362   -0.91
 Residual             37.695   6.1396        
Number of obs: 3454, groups:  schoolnr, 211

Fixed effects:
                   Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)        41.53703    0.26042  227.00252 159.498  &lt; 2e-16 ***
IQ_verb             3.04827    0.13812 1307.60896  22.070  &lt; 2e-16 ***
IQsq_min            0.19935    0.03692 1455.30999   5.399 7.82e-08 ***
IQsq_pl            -0.27149    0.04154 1701.53726  -6.536 8.31e-11 ***
ses                 0.17408    0.01224 3240.41850  14.221  &lt; 2e-16 ***
IQ_mean             0.78388    0.29975  223.47954   2.615  0.00953 ** 
SES_mean           -0.08140    0.04383  253.35206  -1.857  0.06445 .  
IQ_verb:ses        -0.01272    0.00575 1076.32695  -2.211  0.02722 *  
IQ_mean:SES_mean   -0.09896    0.03327  263.90254  -2.974  0.00321 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) IQ_vrb IQsq_m IQsq_p ses    IQ_men SES_mn IQ_vr:
IQ_verb     -0.141                                                 
IQsq_min    -0.114  0.765                                          
IQsq_pl     -0.077 -0.791 -0.536                                   
ses         -0.006 -0.143  0.014  0.057                            
IQ_mean     -0.085 -0.072 -0.056 -0.066  0.054                     
SES_mean     0.048  0.044  0.047  0.010 -0.270 -0.507              
IQ_verb:ses  0.012  0.020 -0.255 -0.201 -0.141  0.043 -0.148       
IQ_mn:SES_m -0.362  0.054  0.032 -0.086  0.020  0.175 -0.017 -0.101</code></pre>
</div>
</div>
<p>Study the level-2 residuals in comparison to the related group mean of IQ, by plotting. Add a smoothed line of the residuals to assess whether the chosen explanatory variables and random effects match the assumptions (key word: linearity) For this use the R function <code>smooth.spline</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>be_u <span class="ot">&lt;-</span> <span class="fu">ranef</span>(mod10)<span class="sc">$</span>schoolnr[[<span class="dv">1</span>]]</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>RES <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">unique</span>(DAT<span class="sc">$</span>schoolnr), be_u, DAT[<span class="sc">!</span><span class="fu">duplicated</span>(DAT<span class="sc">$</span>schoolnr), <span class="st">"IQ_mean"</span>])</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(RES[,<span class="dv">3</span>], RES[,<span class="dv">2</span>], <span class="at">xlab=</span><span class="st">"IQ_mean"</span>, <span class="at">ylab=</span><span class="st">"U_0j"</span>)</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>smooth <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(<span class="at">x=</span>RES[,<span class="dv">3</span>], <span class="at">y=</span>RES[,<span class="dv">2</span>])</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(smooth<span class="sc">$</span>x, smooth<span class="sc">$</span>y, <span class="at">pch=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The smooth spline indicates homoskedasticity, the assumption is supported by this plot.</p>
<p>Check normality of the residuals using a normal probability plot of standardized level-2 residuals Overall: What do you see? What do you conclude?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>res_std_w <span class="ot">&lt;-</span> be_u<span class="sc">/</span><span class="fu">sd</span>(be_u)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(res_std_w)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(res_std_w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multi-level_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see a straight line with more deviation at the edges, which could be a hint that there is heteroskedasticity is going on.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Preface">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./panel_data.html" class="pagination-link" aria-label="Panel Data">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Panel Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>